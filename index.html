<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HTML Editor</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { 
            --primary: #222450; 
            --text-primary: #171717;
            --text-secondary: #737373;
            --border: #e5e5e5;
            --bg-hover: #f5f5f5;
        }
        * { font-family: 'Pretendard', -apple-system, sans-serif; }
        body { background: #fafafa; color: var(--text-primary); }
        
        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d4d4d4; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a3a3a3; }
        
        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #d4d4d4; transition: .3s; border-radius: 24px; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--primary); }
        input:checked + .toggle-slider:before { transform: translateX(20px); }
        
        /* ë“œë˜ê·¸ í•¸ë“¤ */
        .drag-handle { opacity: 0; transition: opacity .2s; cursor: grab; }
        .block-container:hover .drag-handle { opacity: 1; }
        
        /* ë¸”ë¡ ì»¨í…Œì´ë„ˆ */
        .block-container { position: relative; margin-bottom: 0; padding: 0; border-radius: 6px; transition: all .2s; }
        .block-container:hover { background: transparent; padding: 8px; }
        .block-container:hover { background: #fafafa; }
        .block-container.selected { outline: 2px solid var(--primary); outline-offset: 2px; background: #f5f5ff; }
        
        /* í”„ë¡œí¼í‹° íŒ¨ë„ */
        .property-section { padding: 20px 0; }
        
        /* ì¸í’‹ */
        .input-field { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; transition: border .2s; }
        .input-field:focus { outline: none; border-color: var(--primary); }
        
        /* ë²„íŠ¼ */
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; transition: all .2s; cursor: pointer; border: none; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-secondary { background: var(--bg-hover); color: var(--text-primary); }
        .btn-secondary:hover { background: #e5e5e5; }
        
        /* ë¸”ë¡ ì•„ì´í…œ */
        .block-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 6px; cursor: grab; transition: background .2s; margin-bottom: 4px; }
        .block-item:hover { background: var(--bg-hover); }
        .block-item-icon { width: 20px; height: 20px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .block-item-icon svg { width: 18px; height: 18px; }
        
        /* íƒ­ */
        .tab-button { padding: 8px 16px; border: none; background: transparent; color: var(--text-secondary); font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; transition: all .2s; }
        .tab-button.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        /* ìº”ë²„ìŠ¤ ì˜ì—­ - ìœ¤ê³ ë”• í°íŠ¸ ì ìš© */
        #canvas, #sidebar-canvas { 
            font-family: 'YoonGothicPro740', 'YoonGothicPro760', 'YoonGothicPro780', 'Montserrat', sans-serif !important;
        }
        
        /* í¸ì§‘ ì˜ì—­ í…ìŠ¤íŠ¸ ë¸”ë¡ */
        .text-block, .exported-font { 
            font-family: 'YoonGothicPro740', 'YoonGothicPro760', 'YoonGothicPro780', 'Montserrat', sans-serif !important; 
            line-height: 1.6; 
        }
        
        /* ë¯¸ë¦¬ë³´ê¸° ëª¨ë“œ */
        .canvas-wrapper { background: transparent; border-radius: 0; box-shadow: none; transition: all .3s; }

        /* ì´ë¯¸ì§€ ë¶„í•  ë° ì—´ ë¶„í•  ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .image-split-container, .columns-container {
                flex-direction: column !important;
                gap: 12px !important;
            }
        }
        
        /* í…ìŠ¤íŠ¸ íˆ´ë°” */
        #text-toolbar { position: fixed; z-index: 1000; background: #262626; border-radius: 8px; padding: 4px; display: flex; gap: 2px; box-shadow: 0 4px 12px rgba(0,0,0,.15); opacity: 0; pointer-events: none; transition: opacity .2s; }
        #text-toolbar.show { opacity: 1; pointer-events: auto; }
        #text-toolbar button { padding: 6px 10px; background: transparent; border: none; color: white; border-radius: 4px; cursor: pointer; transition: background .2s; font-size: 14px; }
        #text-toolbar button:hover { background: #404040; }
        
        /* ì»¬ëŸ¬ ì„ íƒ */
        .color-swatch { width: 32px; height: 32px; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: border .2s; }
        .color-swatch:hover { border-color: var(--primary); }
        
        /* ë°ìŠ¤í¬íƒ‘/ëª¨ë°”ì¼ ë·° ì „í™˜ */
        #canvas-wrapper.preview-mode-desktop .canvas-content-wrapper { width: fit-content; }
        #canvas-wrapper.preview-mode-mobile .canvas-content-wrapper { width: fit-content; }
        #canvas-wrapper.preview-mode-mobile #canvas { width: 375px !important; }
        #canvas-wrapper.preview-mode-mobile .canvas-flex { flex-direction: column !important; }
        #canvas-wrapper.preview-mode-mobile #vertical-divider { display: none !important; }
        #canvas-wrapper.preview-mode-mobile #sidebar-canvas { width: 375px !important; padding-top: 0 !important; }
        #canvas-wrapper.preview-mode-mobile .mobile-divider { display: flex !important; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">
    <!-- í—¤ë” -->
<header class="bg-white border-b border-gray-200 px-6 py-3 flex items-center justify-between">
    <div class="flex items-center gap-4">
        <h1 class="text-lg font-bold text-gray-900">HTML EDITOR</h1>
    </div>
    <div class="flex items-center gap-3">
        <!-- ğŸ’¾ JSON ì €ì¥ ë²„íŠ¼ -->
        <button onclick="downloadJSON()" class="p-2 text-gray-600 hover:text-gray-900 rounded-lg transition" title="JSON íŒŒì¼ë¡œ ì €ì¥">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
            </svg>
        </button>
        
        <!-- ğŸ“‚ JSON ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ -->
        <button onclick="uploadJSON()" class="p-2 text-gray-600 hover:text-gray-900 rounded-lg transition" title="JSON íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
        </button>
        
        <!-- ğŸ—‘ï¸ ì €ì¥ ë°ì´í„° ì‚­ì œ ë²„íŠ¼ -->
        <button onclick="clearLocalStorage()" class="p-2 text-red-600 hover:text-red-900 rounded-lg transition" title="ìë™ ì €ì¥ ë°ì´í„° ì‚­ì œ">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
        </button>
        
        <div class="w-px h-6 bg-gray-300"></div>
        
        <!-- ê¸°ì¡´ ë„ì›€ë§ ë²„íŠ¼ -->
        <button onclick="openHelpModal()" class="p-2 text-gray-600 hover:text-gray-900 rounded-lg transition" title="ë„ì›€ë§">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
        </button>
    </div>
</header>
  <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="flex flex-1 overflow-hidden">
        <!-- ì™¼ìª½: ë¸”ë¡ ë„êµ¬ -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col">
            <!-- Undo/Redo -->
            <div class="px-4 pt-4 pb-3 border-b border-gray-200 flex gap-2">
                <button id="undo-btn" class="flex-1 p-2 rounded-md hover:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed" title="ì‹¤í–‰ ì·¨ì†Œ (Ctrl+Z)">
                    <svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                    </svg>
                </button>
                <button id="redo-btn" class="flex-1 p-2 rounded-md hover:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed" title="ì‹¤í–‰ ë³µêµ¬ (Ctrl+Y)">
                    <svg class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10H11a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"/>
                    </svg>
                </button>
            </div>
            
            <!-- ë¸”ë¡ ë¦¬ìŠ¤íŠ¸ -->
            <div id="block-tools" class="flex-1 overflow-y-auto p-4">

                <!-- ê³µí†µ ë¸”ë¡ -->
                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase mb-3 px-2">ê³µí†µ ë¸”ë¡</h3>
                    <div draggable="true" data-type="text" class="block-item">
                        <div class="block-item-icon">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium">í…ìŠ¤íŠ¸</span>
                    </div>
                    <div draggable="true" data-type="image" class="block-item">
                        <div class="block-item-icon">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium">ì´ë¯¸ì§€</span>
                    </div>
                    <div draggable="true" data-type="columns" class="block-item">
                        <div class="block-item-icon">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 4H5a2 2 0 00-2 2v12a2 2 0 002 2h4m11-9v5m0 0l-3-3m3 3l3-3M9 4v16m0-16l3 3m-3-3L6 7"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium">ì—´ ë¶„í• </span>
                    </div>
                    <div draggable="true" data-type="divider" class="block-item">
                        <div class="block-item-icon">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium">êµ¬ë¶„ì„ </span>
                    </div>
                    <div draggable="true" data-type="spacer" class="block-item">
                        <div class="block-item-icon">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium">ê³µë°±</span>
                    </div>
                </div>
                
                <!-- ë³¸ë¬¸ ì „ìš© -->
                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase mb-3 px-2">ë³¸ë¬¸ ì „ìš©</h3>
                    <div draggable="true" data-type="button" data-area="main" class="block-item">
                        <div class="block-item-icon">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium">ë²„íŠ¼</span>
                    </div>
                <div draggable="true" data-type="toggle" data-area="main" class="block-item">
                        <div class="block-item-icon">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium">í† ê¸€</span>
                    </div>                  
                    <div draggable="true" data-type="banner" data-area="main" class="block-item">
                        <div class="block-item-icon">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium">ë°°ë„ˆ</span>
                    </div>
                    <div draggable="true" data-type="label" data-area="main" class="block-item">
                        <div class="block-item-icon">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium">ë¼ë²¨</span>
                    </div>
                    <div draggable="true" data-type="callout" data-area="main" class="block-item">
                        <div class="block-item-icon">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium">ì½œì•„ì›ƒ</span>
                    </div>
                </div>
                
                <!-- ë¦¬ìŠ¤íŠ¸ ì „ìš© -->
                <div>
                    <h3 class="text-xs font-semibold text-gray-400 uppercase mb-3 px-2">ë¦¬ìŠ¤íŠ¸ ì „ìš©</h3>
                    <div draggable="true" data-type="listitem" data-area="sidebar" class="block-item">
                        <div class="block-item-icon">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                        </div>
                        <span class="text-sm font-medium">ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ</span>
                    </div>
                </div>
            </div>
        </aside>
 <!-- ì¤‘ì•™: í¸ì§‘ ì˜ì—­ -->
        <main class="flex-1 flex flex-col overflow-hidden bg-gray-50">
            <!-- ë¯¸ë¦¬ë³´ê¸° ì»¨íŠ¸ë¡¤ -->
            <div class="bg-white border-b border-gray-200 px-6 py-3 flex items-center justify-between">
                <div class="flex items-center gap-6">
                    <div class="flex bg-gray-100 rounded-lg p-1">
                        <button id="desktop-view" class="px-4 py-1.5 rounded-md bg-white text-sm font-medium shadow-sm flex items-center gap-1" onclick="switchView('desktop')">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            ë°ìŠ¤í¬íƒ‘
                        </button>
                        <button id="mobile-view" class="px-4 py-1.5 rounded-md text-sm font-medium text-gray-600 flex items-center gap-1" onclick="switchView('mobile')">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                            ëª¨ë°”ì¼
                        </button>
                    </div>
                    <div class="flex items-center gap-4 text-sm text-gray-600">
                        <div class="flex items-center gap-2">
                            <label for="width-input" class="font-medium">ë³¸ë¬¸ ê°€ë¡œ (px):</label>
                            <input id="width-input" type="number" min="320" max="1200" value="660" class="w-20 p-1 border border-gray-300 rounded-md text-center" />
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="padding-input" class="font-medium">ìƒë‹¨ ì—¬ë°± (px):</label>
                            <input id="padding-input" type="number" min="0" max="100" value="50" class="w-20 p-1 border border-gray-300 rounded-md text-center" />
                        </div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="hide-search-results" class="w-4 h-4 rounded border-gray-300" checked />
                            <span class="font-medium">ìƒí’ˆ ì˜ì—­ ìˆ¨ê¸°ê¸°</span>
                        </label>
                    </div>
                </div>
                <button onclick="copyHTML()" class="btn btn-primary text-sm flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    HTML ë³µì‚¬
                </button>
            </div>
            
            <!-- ìº”ë²„ìŠ¤ -->
            <div id="canvas-wrapper" class="flex-1 overflow-auto p-8 preview-mode-desktop" style="background: #ffffff;">
                <div class="canvas-content-wrapper mx-auto">
                    <div class="canvas-flex flex gap-0">
                        <!-- ë³¸ë¬¸ ì˜ì—­ -->
                        <div id="canvas" class="canvas-wrapper" style="width: 660px; min-height: 500px; padding: 50px 16px 40px;">
                            <div class="text-center text-gray-400 py-20">
                                <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <h3 class="text-lg font-semibold mb-2" style="font-family: 'Pretendard', sans-serif;">ë¸”ë¡ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</h3>
                                <p class="text-sm" style="font-family: 'Pretendard', sans-serif;">ì½˜í…ì¸  ë³¸ë¬¸ ì˜ì—­ì…ë‹ˆë‹¤</p>
                            </div>
                        </div>
                        
                        <!-- ì„¸ë¡œ êµ¬ë¶„ì„  -->
                        <div id="vertical-divider" class="flex items-center justify-center" style="width: 80px; flex-shrink: 0;">
                            <div style="width: 1px; background: #e5e7eb; height: 100%;"></div>
                        </div>
                        
                        <!-- ëª¨ë°”ì¼ìš© ê°€ë¡œ êµ¬ë¶„ì„  -->
                        <div class="mobile-divider" style="display: none; width: 100%; padding: 32px 15px; align-items: center; justify-content: center;">
                            <div style="width: 100%; height: 1px; background: #e5e7eb;"></div>
                        </div>
                        
                        <!-- ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
                        <div id="sidebar-canvas" class="canvas-wrapper" style="width: 200px; min-height: 800px; padding: 50px 16px 40px;">
                            <div class="text-center text-gray-400 py-20">
                                <svg class="w-12 h-12 mx-auto mb-3 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"/>
                                </svg>
                                <h4 class="text-sm font-semibold mb-1" style="font-family: 'Pretendard', sans-serif;">ë¦¬ìŠ¤íŠ¸ ì˜ì—­</h4>
                                <p class="text-xs" style="font-family: 'Pretendard', sans-serif;">ë¦¬ìŠ¤íŠ¸ ë¸”ë¡ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
      <!-- ì˜¤ë¥¸ìª½: ì†ì„± íŒ¨ë„ -->
        <aside id="properties-panel" class="w-80 bg-white border-l border-gray-200 overflow-y-auto">
            <div id="properties-content" class="p-6">
                <!-- ì„ íƒëœ ë¸”ë¡ì´ ì—†ì„ ë•Œ -->
                <div id="no-selection" class="text-center py-20 text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
                    </svg>
                    <p class="text-sm">ë¸”ë¡ì„ ì„ íƒí•˜ì—¬ í¸ì§‘í•˜ì„¸ìš”</p>
                </div>
            </div>
        </aside>
    </div>
    
    <!-- í…ìŠ¤íŠ¸ íˆ´ë°” -->
    <div id="text-toolbar">
        <button onclick="editor.formatText('bold')" title="ë³¼ë“œ"><strong>B</strong></button>
        <button onclick="editor.formatText('italic')" title="ê¸°ìš¸ì„"><em>I</em></button>
        <button onclick="editor.formatText('underline')" title="ë°‘ì¤„"><u>U</u></button>
        <span class="w-px bg-gray-600 mx-1"></span>
        <button onclick="editor.applyHeading('h1', '28px')" title="ë©”ì¸ ì œëª©">H1</button>
        <button onclick="editor.applyHeading('h2', '22px')" title="ì„œë¸Œ ì œëª©">H2</button>
        <button onclick="editor.applyHeading('h3', '18px')" title="ì†Œì œëª©">H3</button>
        <button onclick="editor.applyHeading('p', '16px')" title="ë³¸ë¬¸">ë³¸ë¬¸</button>
        <button onclick="editor.applyHeading('p', '14px')" title="ìº¡ì…˜">ìº¡ì…˜</button>
        <span class="w-px bg-gray-600 mx-1"></span>
        <button onclick="editor.formatText('justifyLeft')" title="ì™¼ìª½ ì •ë ¬">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M2 5a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1zM2 10a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1zM2 15a1 1 0 011-1h10a1 1 0 110 2H3a1 1 0 01-1-1z"/></svg>
        </button>
        <button onclick="editor.formatText('justifyCenter')" title="ê°€ìš´ë° ì •ë ¬">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4 5a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM4 10a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM4 15a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1z"/></svg>
        </button>
        <button onclick="editor.formatText('justifyRight')" title="ì˜¤ë¥¸ìª½ ì •ë ¬">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4 5a1 1 0 011-1h14a1 1 0 110 2H5a1 1 0 01-1-1zM4 10a1 1 0 011-1h14a1 1 0 110 2H5a1 1 0 01-1-1zM4 15a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1z"/></svg>
        </button>
        <span class="w-px bg-gray-600 mx-1"></span>
        <button onclick="editor.showColorPicker()" title="ê¸€ì ìƒ‰">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
            </svg>
        </button>
    </div>
    
    <!-- ì»¬ëŸ¬ í”¼ì»¤ ëª¨ë‹¬ -->
    <div id="color-picker-modal" class="hidden fixed inset-0 bg-black/50 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full p-6 transform transition-all opacity-0 scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">ê¸€ì ìƒ‰ìƒ ì„ íƒ</h3>
                <button onclick="closeColorPicker()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">ìƒ‰ìƒ íŒ”ë ˆíŠ¸</label>
                    <div class="grid grid-cols-6 gap-2">
                        <div class="color-swatch" style="background: #000000;" onclick="selectColor('#000000')"></div>
                        <div class="color-swatch" style="background: #ffffff; border: 1px solid #e5e5e5;" onclick="selectColor('#ffffff')"></div>
                        <div class="color-swatch" style="background: #ef4444;" onclick="selectColor('#ef4444')"></div>
                        <div class="color-swatch" style="background: #f97316;" onclick="selectColor('#f97316')"></div>
                        <div class="color-swatch" style="background: #f59e0b;" onclick="selectColor('#f59e0b')"></div>
                        <div class="color-swatch" style="background: #10b981;" onclick="selectColor('#10b981')"></div>
                        <div class="color-swatch" style="background: #3b82f6;" onclick="selectColor('#3b82f6')"></div>
                        <div class="color-swatch" style="background: #8b5cf6;" onclick="selectColor('#8b5cf6')"></div>
                        <div class="color-swatch" style="background: #ec4899;" onclick="selectColor('#ec4899')"></div>
                        <div class="color-swatch" style="background: #78716c;" onclick="selectColor('#78716c')"></div>
                        <div class="color-swatch" style="background: #6366f1;" onclick="selectColor('#6366f1')"></div>
                        <div class="color-swatch" style="background: #14b8a6;" onclick="selectColor('#14b8a6')"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">ì§ì ‘ ì…ë ¥</label>
                    <div class="flex gap-2">
                        <input type="color" id="color-picker-input" class="w-12 h-10 border border-gray-300 rounded-md cursor-pointer" value="#000000" oninput="document.getElementById('color-hex-input').value = this.value.toUpperCase()" />
                        <input type="text" id="color-hex-input" class="flex-1 input-field uppercase" value="#000000" oninput="document.getElementById('color-picker-input').value = this.value" />
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button class="btn btn-secondary" onclick="closeColorPicker()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="applyColor()">ì ìš©</button>
            </div>
        </div>
    </div>
    
    <!-- ë„ì›€ë§ ëª¨ë‹¬ -->
    <div id="help-modal" class="hidden fixed inset-0 bg-black/50 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto p-6 transform transition-all opacity-0 scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">ì—ë””í„° ì‚¬ìš© ë°©ë²•</h2>
                <button onclick="closeHelpModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="space-y-4 text-sm text-gray-700">
                <div>
                    <h3 class="font-semibold mb-2">1. ë¸”ë¡ ì¶”ê°€í•˜ê¸°</h3>
                    <p>ì™¼ìª½ì—ì„œ ì›í•˜ëŠ” ë¸”ë¡ì„ ë“œë˜ê·¸í•˜ì—¬ ë³¸ë¬¸ ë˜ëŠ” ë¦¬ìŠ¤íŠ¸ ì˜ì—­ì— ë†“ìœ¼ì„¸ìš”.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">2. í…ìŠ¤íŠ¸ í¸ì§‘í•˜ê¸°</h3>
                    <p>í…ìŠ¤íŠ¸ë¥¼ ì„ íƒí•˜ë©´ ì„œì‹ íˆ´ë°”ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. ë³¼ë“œ, ê¸°ìš¸ì„, ì œëª© ìŠ¤íƒ€ì¼ ë“±ì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">3. ë¸”ë¡ ìˆ˜ì •í•˜ê¸°</h3>
                    <p>ë¸”ë¡ì„ í´ë¦­í•˜ë©´ ì˜¤ë¥¸ìª½ íŒ¨ë„ì—ì„œ ì„¸ë¶€ ì†ì„±ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">4. ë¸”ë¡ ìˆœì„œ ë³€ê²½</h3>
                    <p>ë¸”ë¡ ì™¼ìª½ì˜ ë“œë˜ê·¸ í•¸ë“¤ì„ ì¡ê³  ìœ„ì•„ë˜ë¡œ ì´ë™í•˜ì—¬ ìˆœì„œë¥¼ ë°”ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">5. ë°ìŠ¤í¬íƒ‘/ëª¨ë°”ì¼ ë¯¸ë¦¬ë³´ê¸°</h3>
                    <p>ìƒë‹¨ì˜ ë°ìŠ¤í¬íƒ‘/ëª¨ë°”ì¼ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í™”ë©´ í¬ê¸°ë³„ ë¯¸ë¦¬ë³´ê¸°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">6. HTML ë‚´ë³´ë‚´ê¸°</h3>
                    <p>ì™„ì„± í›„ 'HTML ë³µì‚¬' ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì½”ë“œê°€ ë³µì‚¬ë©ë‹ˆë‹¤. ì‚¬ì´íŠ¸ì— ë°”ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">7. ë³¸ë¬¸ ê°€ë¡œ/ìƒë‹¨ ì—¬ë°±</h3>
                  <p>ë°ìŠ¤í¬íƒ‘ ì™¼ìª½ ë³¸ë¬¸ ê°€ë¡œ ì‚¬ì´ì¦ˆì™€ ë°ìŠ¤í¬íƒ‘, ëª¨ë°”ì¼ ê³µí†µ ìƒë‹¨ ì—¬ë°±ì„ ì„¤ì •í• ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                  <p>*ê¸°ë³¸ê°’ ë³¸ë¬¸ ê°€ë¡œ 660px / ìƒë‹¨ ì—¬ë°± 50px</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">8. ìƒí’ˆ ì˜ì—­ ìˆ¨ê¸°ê¸°</h3>
                    <p>ì–´ë“œë¯¼ > ê²€ìƒ‰ ê´€ë¦¬ > ê²€ìƒ‰ì–´ ê´€ë¦¬ > TOP BANNER ì˜ì—­ì— ì½”ë“œë¥¼ ë¶™ì—¬ ë„£ì„ ë•Œ í™œìš©í•˜ëŠ” ë²„íŠ¼ì…ë‹ˆë‹¤. ìƒí’ˆ ì˜ì—­ ìˆ¨ê¸°ê¸°ì— ì²´í¬ê°€ ë˜ì–´ ìˆìœ¼ë©´ ìƒí’ˆ ëª©ë¡ì´ ë‚˜ì˜¤ì§€ ì•Šì•„ ì¼ë°˜ í˜ì´ì§€ì²˜ëŸ¼ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">9. ìë™ ì €ì¥ ê¸°ëŠ¥</h3>
                    <p>ë¸”ë¡ì„ ì¶”ê°€/ìˆ˜ì • ì‹œ ìë™ ì €ì¥ë˜ë©° ìˆ˜ì •ì´ ì—†ì–´ë„ 5ë¶„ë§ˆë‹¤ ìë™ ì €ì¥ë©ë‹ˆë‹¤.(ìƒˆë¡œê³ ì¹¨ ë˜ëŠ” ë¸Œë¼ìš°ì € ë‹«ì•„ë„ ìœ ì§€ë¨)</p>
                    <p>*ë‹¨, ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ëŠ” ë°©ì‹ì´ë¼ ìºì‹œê°€ ì‚­ì œë˜ë©´ ë°ì´í„°ë„ ì‚­ì œë©ë‹ˆë‹¤.</p>
                    <p>*ìë™ ì €ì¥ëœ ë°ì´í„°ëŠ” ìš°ì¸¡ ìƒë‹¨ íœ´ì§€í†µ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">10. ìˆ˜ë™ ì €ì¥ ë° ë¶ˆëŸ¬ì˜¤ê¸°</h3>
                    <p>ìš°ì¸¡ ìƒë‹¨ ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ JSON íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <p>ë¶ˆëŸ¬ì˜¬ ë•Œë„ ë§ˆì°¬ê°€ì§€ë¡œ JSON íŒŒì¼ì„ ì—…ë¡œë“œ ë²„íŠ¼ìœ¼ë¡œ ì—…ë¡œë“œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">*ë¬¸ì˜ì‚¬í•­</h3>
                    <p>ì‚¬ìš© ì¤‘ ë¶ˆí¸ ì‚¬í•­ ë˜ëŠ” ë¬¸ì˜ ì‚¬í•­ì€ ê¸°íšíŒ€ ë°°ìŠ¹ì§„ ê³¼ì¥ì—ê²Œ ì „ë‹¬í•´ ì£¼ì„¸ìš”.</p>
                </div>

            </div>
        </div>
    </div>
    
    <!-- í† ìŠ¤íŠ¸ -->
    <div id="toast-container" class="fixed top-6 right-6 z-50"></div>

    <script>
    // UUID ìƒì„±
    const generateUUID = () => {
        if (window.crypto && typeof window.crypto.randomUUID === 'function') return window.crypto.randomUUID();
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    };

    // ë””ë°”ì´ìŠ¤ ê°ì§€ í•¨ìˆ˜
    const detectDevice = () => {
        const hostname = window.location.hostname;
        if (hostname.includes('app100.publog.co.kr')) return 'aos';
        if (hostname.includes('app200.publog.co.kr')) return 'ios';
        if (hostname.includes('m.publog.co.kr')) return 'mo';
        if (hostname.includes('www.publog.co.kr')) return 'web';
        return 'web'; // ê¸°ë³¸ê°’
    };

    // ë””ë°”ì´ìŠ¤ë³„ ëœë”© URL ê°€ì ¸ì˜¤ê¸°
    const getLandingUrl = (block, imageKey = null) => {
        const device = detectDevice();
        const target = imageKey ? block[imageKey] : block;

        // ë””ë°”ì´ìŠ¤ë³„ URL í™•ì¸
        const urlMap = {
            aos: target?.landingUrlAos || '',
            ios: target?.landingUrlIos || '',
            web: target?.landingUrlWeb || '',
            mo: target?.landingUrlMo || ''
        };

        // í˜„ì¬ ë””ë°”ì´ìŠ¤ì˜ URLì´ ìˆìœ¼ë©´ ë°˜í™˜, ì—†ìœ¼ë©´ ê¸°ì¡´ landingUrl ì‚¬ìš© (í•˜ìœ„ í˜¸í™˜)
        return urlMap[device] || target?.landingUrl || '';
    };

    // ì „ì—­ ë³€ìˆ˜
    let blocks = [];
    let sidebarBlocks = [];
    let history = [];
    let historyIndex = -1;
    let selectedBlock = null;
    let currentView = 'desktop';
    const MAX_HISTORY = 20;

    // DOM ìš”ì†Œ
    const canvas = document.getElementById('canvas');
    const sidebarCanvas = document.getElementById('sidebar-canvas');
    const verticalDivider = document.getElementById('vertical-divider');
    const propertiesPanel = document.getElementById('properties-panel');
    const propertiesContent = document.getElementById('properties-content');
    const textToolbar = document.getElementById('text-toolbar');
    const undoBtn = document.getElementById('undo-btn');
    const redoBtn = document.getElementById('redo-btn');
    const widthInput = document.getElementById('width-input');
    const paddingInput = document.getElementById('padding-input');

    // ì—ë””í„° ê°ì²´
    const editor = {
        currentSelection: null,
        currentTextNode: null,
        savedRange: null,
        savedTextNode: null,
        
        saveState: () => {
            history = history.slice(0, historyIndex + 1);
            const state = JSON.stringify({ blocks, sidebarBlocks });
            history.push(state);
            if (history.length > MAX_HISTORY) history.shift();
            historyIndex = history.length - 1;
            editor.updateHistoryButtons();
        },
        
        updateHistoryButtons: () => {
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= history.length - 1;
        },
        
        formatText: (command, value = null) => {
            document.execCommand(command, false, value);
            setTimeout(editor.positionToolbar, 50);
            setTimeout(() => {
                if (editor.currentTextNode) {
                    const container = editor.currentTextNode.closest('.block-container');
                    const blockId = container.getAttribute('data-id');
                    const isMain = canvas.contains(container);
                    const blockArray = isMain ? blocks : sidebarBlocks;
                    const block = blockArray.find(b => b.id === blockId);
                    if (block) {
                        block.content = editor.currentTextNode.innerHTML;
                        editor.saveState();
                    }
                }
            }, 100);
        },
        
        positionToolbar: () => {
            const selection = window.getSelection();
            editor.currentSelection = selection;
            if (!selection.rangeCount) {
                textToolbar.classList.remove('show');
                editor.currentTextNode = null;
                return;
            }
            const range = selection.getRangeAt(0);
            const containerEl = range.startContainer.nodeType === 3 ? range.startContainer.parentNode : range.startContainer;
            const textBlockEl = containerEl.closest('.text-block');
            if (!range.collapsed && textBlockEl) {
                const rect = range.getBoundingClientRect();
                const top = rect.top - textToolbar.offsetHeight - 10;
                const left = rect.left + rect.width / 2 - textToolbar.offsetWidth / 2;
                textToolbar.style.top = `${top}px`;
                textToolbar.style.left = `${left}px`;
                textToolbar.classList.add('show');
                editor.currentTextNode = textBlockEl;
            } else {
                textToolbar.classList.remove('show');
                editor.currentTextNode = null;
            }
        },
        
        applyHeading: (tag, fontSize) => {
            if (!editor.currentSelection || editor.currentSelection.isCollapsed) return;
            const selection = window.getSelection();
            const range = selection.getRangeAt(0);
            const textNode = editor.currentTextNode;
            if (!textNode) return;
            
            const selectedText = range.toString();
            const wrapper = document.createElement(tag);
            wrapper.style.fontSize = fontSize;
            wrapper.textContent = selectedText;
            
            range.deleteContents();
            range.insertNode(wrapper);
            
            const container = textNode.closest('.block-container');
            const blockId = container.getAttribute('data-id');
            const isMain = canvas.contains(container);
            const blockArray = isMain ? blocks : sidebarBlocks;
            const block = blockArray.find(b => b.id === blockId);
            if (block) {
                block.content = textNode.innerHTML;
                editor.saveState();
            }
            
            selection.removeAllRanges();
            textToolbar.classList.remove('show');
        },
        
        showColorPicker: () => {
            if (!editor.currentSelection || editor.currentSelection.isCollapsed) return;
            
            const selection = window.getSelection();
            const range = selection.getRangeAt(0).cloneRange();
            const textNode = editor.currentTextNode;
            editor.savedRange = range;
            editor.savedTextNode = textNode;
            
            const modal = document.getElementById('color-picker-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('flex');
                modal.querySelector('div').classList.remove('opacity-0', 'scale-95');
            }, 10);
        }
    };
      // ============================================
    // ğŸ’¾ ì €ì¥ ê¸°ëŠ¥ ì¶”ê°€
    // ============================================

    // LocalStorage ìë™ ì €ì¥
    const originalSaveState = editor.saveState;
    editor.saveState = () => {
        originalSaveState();

        try {
            const data = {
                blocks,
                sidebarBlocks,
                settings: {
                    width: widthInput.value,
                    padding: paddingInput.value,
                    hideSearchResults: document.getElementById('hide-search-results').checked
                },
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('publog_editor_data', JSON.stringify(data));
            console.log('âœ… ìë™ ì €ì¥:', new Date().toLocaleTimeString());
        } catch (err) {
            // localStorage ì‚¬ìš© ë¶ˆê°€ í™˜ê²½ - SecurityErrorëŠ” ë¬´ì‹œ
            if (err.name !== 'SecurityError') {
                console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', err);
            }
        }
    };

    // LocalStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadFromLocalStorage() {
        try {
            const saved = localStorage.getItem('publog_editor_data');
            if (saved) {
                const data = JSON.parse(saved);
                blocks = data.blocks || [];
                sidebarBlocks = data.sidebarBlocks || [];

                if (data.settings) {
                    widthInput.value = data.settings.width || 700;
                    paddingInput.value = data.settings.padding || 50;
                    document.getElementById('hide-search-results').checked = 
                        data.settings.hideSearchResults ?? true;

                    canvas.style.width = `${widthInput.value}px`;
                    canvas.style.paddingTop = `${paddingInput.value}px`;
                    sidebarCanvas.style.paddingTop = `${paddingInput.value}px`;
                }

                renderCanvas();
                renderSidebar();
                editor.saveState();

                const savedTime = new Date(data.timestamp).toLocaleString();
                showToast(`ğŸ“‚ ${savedTime} ì €ì¥ë³¸ ë¶ˆëŸ¬ì˜´`, 'success');
                return true;
            }
        } catch (err) {
            // localStorage ì‚¬ìš© ë¶ˆê°€ í™˜ê²½ - SecurityErrorëŠ” ë¬´ì‹œ
            if (err.name !== 'SecurityError') {
                console.error('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
            }
        }
        return false;
    }

// JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    function downloadJSON() {
        const data = {
            version: '2.2',
            blocks,
            sidebarBlocks,
            settings: {
                width: widthInput.value,
                padding: paddingInput.value,
                hideSearchResults: document.getElementById('hide-search-results').checked
            },
            timestamp: new Date().toISOString()
        };

        const now = new Date();
        const filename = `publog_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}.json`;

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('ğŸ’¾ JSON íŒŒì¼ ì €ì¥ ì™„ë£Œ', 'success');
    }

    // JSON íŒŒì¼ ì—…ë¡œë“œ
    function uploadJSON() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    if (data.version !== '2.0') {
                        if (!confirm('ë‹¤ë¥¸ ë²„ì „ì˜ íŒŒì¼ì…ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?')) return;
                    }
                    
                    blocks = data.blocks || [];
                    sidebarBlocks = data.sidebarBlocks || [];
                    
                    if (data.settings) {
                        widthInput.value = data.settings.width || 700;
                        paddingInput.value = data.settings.padding || 50;
                        document.getElementById('hide-search-results').checked = 
                            data.settings.hideSearchResults ?? true;
                        
                        canvas.style.width = `${widthInput.value}px`;
                        canvas.style.paddingTop = `${paddingInput.value}px`;
                        sidebarCanvas.style.paddingTop = `${paddingInput.value}px`;
                    }
                    
                    renderCanvas();
                    renderSidebar();
                    editor.saveState();
                    
                    selectedBlock = null;
                    updatePropertiesPanel(null);
                    
                    showToast('ğŸ“‚ JSON íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ', 'success');
                } catch (err) {
                    showToast('âŒ íŒŒì¼ ì˜¤ë¥˜: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        };
        
        input.click();
    }

    // LocalStorage ë°ì´í„° ì‚­ì œ
    function clearLocalStorage() {
        try {
            if (confirm('âš ï¸ ìë™ ì €ì¥ëœ ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?\n(í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë‚´ìš©ì€ ìœ ì§€ë©ë‹ˆë‹¤)')) {
                localStorage.removeItem('publog_editor_data');
                showToast('ğŸ—‘ï¸ ì €ì¥ ë°ì´í„° ì‚­ì œ ì™„ë£Œ', 'success');
            }
        } catch (err) {
            showToast('âš ï¸ ìë™ ì €ì¥ì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” í™˜ê²½ì…ë‹ˆë‹¤', 'error');
        }
    }

    // 5ë¶„ë§ˆë‹¤ ìë™ ë°±ì—…
    setInterval(() => {
        try {
            if (blocks.length > 0 || sidebarBlocks.length > 0) {
                const data = {
                    blocks,
                    sidebarBlocks,
                    settings: {
                        width: widthInput.value,
                        padding: paddingInput.value,
                        hideSearchResults: document.getElementById('hide-search-results').checked
                    },
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('publog_editor_data', JSON.stringify(data));
                console.log('ğŸ”„ ìë™ ë°±ì—…:', new Date().toLocaleTimeString());
            }
        } catch (err) {
            // localStorage ì‚¬ìš© ë¶ˆê°€ í™˜ê²½ - ì¡°ìš©íˆ ë¬´ì‹œ
        }
    }, 5 * 60 * 1000);
      
      // ì»¬ëŸ¬ ì„ íƒ
    function selectColor(color) {
        document.getElementById('color-picker-input').value = color;
        document.getElementById('color-hex-input').value = color.toUpperCase();
    }
    
    // ì»¬ëŸ¬ ì ìš©
    function applyColor() {
        const color = document.getElementById('color-hex-input').value;
        if (editor.savedRange && editor.savedTextNode) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(editor.savedRange);
            document.execCommand('foreColor', false, color);
            
            const container = editor.savedTextNode.closest('.block-container');
            const blockId = container.getAttribute('data-id');
            const isMain = canvas.contains(container);
            const blockArray = isMain ? blocks : sidebarBlocks;
            const block = blockArray.find(b => b.id === blockId);
            if (block) {
                block.content = editor.savedTextNode.innerHTML;
                editor.saveState();
            }
            
            editor.savedRange = null;
            editor.savedTextNode = null;
        }
        closeColorPicker();
    }
    
    // ì»¬ëŸ¬ í”¼ì»¤ ë‹«ê¸°
    function closeColorPicker() {
        const modal = document.getElementById('color-picker-modal');
        modal.querySelector('div').classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }, 300);
    }

    // ë·° ì „í™˜
    function switchView(view) {
        currentView = view;
        const wrapper = document.getElementById('canvas-wrapper');
        const desktopBtn = document.getElementById('desktop-view');
        const mobileBtn = document.getElementById('mobile-view');
        
        if (view === 'desktop') {
            wrapper.classList.remove('preview-mode-mobile');
            wrapper.classList.add('preview-mode-desktop');
            desktopBtn.classList.add('bg-white', 'shadow-sm');
            desktopBtn.classList.remove('text-gray-600');
            mobileBtn.classList.remove('bg-white', 'shadow-sm');
            mobileBtn.classList.add('text-gray-600');
            
            // ë¦¬ìŠ¤íŠ¸ ì˜ì—­ ë³µì›
            if (sidebarBlocks.length > 0) {
                sidebarCanvas.style.display = 'block';
                verticalDivider.style.display = 'flex';
            }
        } else {
            wrapper.classList.remove('preview-mode-desktop');
            wrapper.classList.add('preview-mode-mobile');
            mobileBtn.classList.add('bg-white', 'shadow-sm');
            mobileBtn.classList.remove('text-gray-600');
            desktopBtn.classList.remove('bg-white', 'shadow-sm');
            desktopBtn.classList.add('text-gray-600');
            
            // ëª¨ë°”ì¼ì—ì„œëŠ” ë¦¬ìŠ¤íŠ¸ê°€ ì•„ë˜ë¡œ ì´ë™
            if (sidebarBlocks.length > 0) {
                sidebarCanvas.style.display = 'block';
            }
        }
    }

    // ê°€ë¡œí­ ë³€ê²½
    widthInput.onchange = (e) => {
        let w = parseInt(e.target.value);
        w = Math.max(320, Math.min(1200, w));
        canvas.style.width = `${w}px`;
        e.target.value = w;
    };

    // ìƒë‹¨ ì—¬ë°± ë³€ê²½
    paddingInput.onchange = (e) => {
        let p = parseInt(e.target.value);
        p = Math.max(0, Math.min(100, p));
        canvas.style.paddingTop = `${p}px`;
        sidebarCanvas.style.paddingTop = `${p}px`;
        e.target.value = p;
    };

    // ë¸”ë¡ ì„ íƒ
    // ë¸”ë¡ì„ ì¬ê·€ì ìœ¼ë¡œ ì°¾ëŠ” í—¬í¼ í•¨ìˆ˜
    function findBlockRecursively(blockId, blockArray) {
        for (let block of blockArray) {
            if (block.id === blockId) {
                return { block, parent: null, columnIndex: null };
            }
            // columns ë¸”ë¡ ë‚´ë¶€ ê²€ìƒ‰
            if (block.type === 'columns' && block.columns) {
                for (let i = 0; i < block.columns.length; i++) {
                    const columnBlocks = block.columns[i] || [];
                    for (let colBlock of columnBlocks) {
                        if (colBlock.id === blockId) {
                            return { block: colBlock, parent: block, columnIndex: i };
                        }
                    }
                }
            }
        }
        return null;
    }

    function selectBlock(blockId, isMain) {
        const blockArray = isMain ? blocks : sidebarBlocks;
        const result = findBlockRecursively(blockId, blockArray);

        if (!result) return;

        selectedBlock = {
            id: blockId,
            isMain,
            parent: result.parent,
            columnIndex: result.columnIndex
        };

        // ëª¨ë“  ë¸”ë¡ì˜ selected í´ë˜ìŠ¤ ì œê±°
        document.querySelectorAll('.block-container').forEach(el => {
            el.classList.remove('selected');
        });

        // ì„ íƒëœ ë¸”ë¡ì— í´ë˜ìŠ¤ ì¶”ê°€
        const container = document.querySelector(`[data-id="${blockId}"]`);
        if (container) container.classList.add('selected');

        // ì†ì„± íŒ¨ë„ ì—…ë°ì´íŠ¸
        updatePropertiesPanel(result.block);
    }

    // ë¸”ë¡ íƒ€ì… ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    function getBlockTypeName(type) {
        const names = {
            text: 'í…ìŠ¤íŠ¸ ë¸”ë¡',
            image: 'ì´ë¯¸ì§€',
            columns: 'ì—´ ë¶„í• ',
            button: 'ë²„íŠ¼',
            banner: 'ë°°ë„ˆ',
            label: 'ë¼ë²¨',
            callout: 'ì½œì•„ì›ƒ ë°•ìŠ¤',
            toggle: 'í† ê¸€ ë¸”ë¡',
            listitem: 'ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ',
            divider: 'êµ¬ë¶„ì„ ',
            spacer: 'ê³µë°±'
        };
        return names[type] || type;
    }
      // ì†ì„± íŒ¨ë„ ì—…ë°ì´íŠ¸
    function updatePropertiesPanel(block) {
        if (!block) {
            propertiesContent.innerHTML = `
                <div id="no-selection" class="text-center py-20 text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
                    </svg>
                    <p class="text-sm">ë¸”ë¡ì„ ì„ íƒí•˜ì—¬ í¸ì§‘í•˜ì„¸ìš”</p>
                </div>`;
            return;
        }
        
        let html = `<div class="space-y-6">`;
        
        // ë¸”ë¡ íƒ€ì… í—¤ë”
        html += `
          <div style="padding-bottom: 20px; border-bottom: 1px solid #e5e5e5; margin-bottom: 20px;">
              <h3 class="text-lg font-semibold">${getBlockTypeName(block.type)}</h3>
              <p class="text-sm text-gray-500 mt-1">ID: ${block.id.substring(0, 8)}</p>
          </div>`;
        
        // ë¸”ë¡ íƒ€ì…ë³„ ì†ì„±
        switch(block.type) {
            case 'text':
                html += `
                    <div class="property-section">
                        <p class="text-sm text-gray-600">í…ìŠ¤íŠ¸ ë¸”ë¡ì€ ì§ì ‘ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¥¼ ì„ íƒí•˜ë©´ ì„œì‹ íˆ´ë°”ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
                    </div>`;
                break;
            case 'toggle':
        html += `
            <div class="property-section">
                <p class="text-sm text-gray-600 mb-3">í† ê¸€ ì œëª©ê³¼ ë‚´ìš©ì€ ì§ì ‘ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¥¼ ì„ íƒí•˜ë©´ ì„œì‹ íˆ´ë°”ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
                <label class="flex items-center gap-2 cursor-pointer">
                    <label class="toggle-switch">
                        <input type="checkbox" ${block.isOpen ? 'checked' : ''} 
                               onchange="updateBlockProperty('${block.id}', 'isOpen', this.checked, true)" />
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="text-sm font-medium">ê¸°ë³¸ ìƒíƒœ: ì—´ë¦¼</span>
                </label>
                <p class="text-xs text-gray-500 mt-2">ì²´í¬í•˜ë©´ í˜ì´ì§€ ë¡œë“œ ì‹œ í† ê¸€ì´ í¼ì³ì§„ ìƒíƒœë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>`;
        break;
            case 'columns':
        const colCount = block.columnCount || 2;
        const columns = block.columns || [];
        const isLocked = block.isLocked || false;
        let totalBlocks = 0;
        columns.forEach(col => { if (col) totalBlocks += col.length; });

        html += `
            <div class="property-section">
                <label class="flex items-center gap-2 cursor-pointer mb-4 p-3 bg-indigo-50 rounded-lg border-2 border-indigo-200">
                    <label class="toggle-switch">
                        <input type="checkbox" ${isLocked ? 'checked' : ''}
                               onchange="updateBlockProperty('${block.id}', 'isLocked', this.checked, ${block.area === 'main'})" />
                        <span class="toggle-slider"></span>
                    </label>
                    <div>
                        <span class="text-sm font-semibold text-indigo-700">ì—´ ë ˆì´ì•„ì›ƒ í™•ì •</span>
                        <p class="text-xs text-indigo-600 mt-1">
                            ${isLocked ? 'âœ“ í™•ì •ë¨ - ë‚´ë¶€ ë¸”ë¡ í¸ì§‘ ê°€ëŠ¥' : 'ë¯¸í™•ì • - ì—´ ê°œìˆ˜ë§Œ ë³€ê²½ ê°€ëŠ¥'}
                        </p>
                    </div>
                </label>
            </div>
            <div class="property-section">
                <label class="block text-sm font-medium mb-2">ì—´ ê°œìˆ˜</label>
                <select class="input-field ${isLocked ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${isLocked ? 'disabled' : ''}
                        onchange="changeColumnCount('${block.id}', parseInt(this.value), ${block.area === 'main'})">
                    <option value="1" ${colCount === 1 ? 'selected' : ''}>1ì—´</option>
                    <option value="2" ${colCount === 2 ? 'selected' : ''}>2ì—´</option>
                    <option value="3" ${colCount === 3 ? 'selected' : ''}>3ì—´</option>
                    <option value="4" ${colCount === 4 ? 'selected' : ''}>4ì—´</option>
                </select>
                <p class="text-xs text-gray-500 mt-2">
                    ${isLocked
                        ? 'ì—´ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚´ë¶€ ë¸”ë¡ì„ í´ë¦­í•˜ì—¬ í¸ì§‘í•˜ì„¸ìš”.'
                        : 'ì™¼ìª½ ë¸”ë¡ ë„êµ¬ì—ì„œ ê° ì—´ë¡œ ë¸”ë¡ì„ ë“œë˜ê·¸í•˜ì„¸ìš”.<br>ë°ìŠ¤í¬íƒ‘: ì¢Œìš° ë°°ì¹˜, ëª¨ë°”ì¼: ìƒí•˜ ë°°ì¹˜'}
                    <br>í˜„ì¬ ${totalBlocks}ê°œì˜ ë¸”ë¡ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>`;
        break;
            case 'image':
    // í•˜ìœ„ í˜¸í™˜ì„± ì²˜ë¦¬
    if (block.isSplit && !block.imageCount) block.imageCount = 2;
    if (block.url && !block.images) {
        block.images = [{
            url: block.url,
            caption: block.caption || '',
            landingUrl: block.landingUrl || '',
            landingUrlAos: block.landingUrlAos || '',
            landingUrlIos: block.landingUrlIos || '',
            landingUrlWeb: block.landingUrlWeb || '',
            landingUrlMo: block.landingUrlMo || '',
            openInNewTab: block.openInNewTab || false
        }];
        block.imageCount = 1;
    }
    if (block.leftImage && !block.images) {
        block.images = [block.leftImage, block.rightImage || {}];
        block.imageCount = 2;
    }

    const count = block.imageCount || 1;
    const images = block.images || [];

    html += `
        <div class="property-section">
            <label class="block text-sm font-medium mb-2">ì´ë¯¸ì§€ ë¶„í• </label>
            <select class="input-field" onchange="changeImageCount('${block.id}', parseInt(this.value), ${block.area === 'main'})">
                <option value="1" ${count === 1 ? 'selected' : ''}>1ê°œ (ë‹¨ì¼)</option>
                <option value="2" ${count === 2 ? 'selected' : ''}>2ë¶„í• </option>
                <option value="3" ${count === 3 ? 'selected' : ''}>3ë¶„í• </option>
                <option value="4" ${count === 4 ? 'selected' : ''}>4ë¶„í• </option>
            </select>
            <p class="text-xs text-gray-500 mt-2">ë°ìŠ¤í¬íƒ‘: ì¢Œìš° ë°°ì¹˜, ëª¨ë°”ì¼: ìƒí•˜ ë°°ì¹˜</p>
        </div>`;

    for (let i = 0; i < count; i++) {
        const img = images[i] || {};
        const label = count === 1 ? 'ì´ë¯¸ì§€' : `ì´ë¯¸ì§€ ${i + 1}`;

        html += `
            <div class="property-section border-t border-gray-200 pt-4">
                <h4 class="font-semibold mb-3 text-indigo-600">${label}</h4>
                <label class="block text-sm font-medium mb-2">ì´ë¯¸ì§€ URL</label>
                <input type="url" class="input-field mb-3" value="${img.url || ''}"
                       onchange="updateImageAtIndex('${block.id}', ${i}, 'url', this.value, ${block.area === 'main'})" />
                <label class="block text-sm font-medium mb-2">ìº¡ì…˜</label>
                <input type="text" class="input-field mb-3" value="${img.caption || ''}"
                       onchange="updateImageAtIndex('${block.id}', ${i}, 'caption', this.value, ${block.area === 'main'})" />
                <label class="block text-sm font-medium mb-2">ëœë”© URL</label>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">AOS</label>
                        <input type="url" class="input-field" placeholder="app100.publog.co.kr" value="${img.landingUrlAos || ''}"
                               onchange="updateImageAtIndex('${block.id}', ${i}, 'landingUrlAos', this.value, ${block.area === 'main'})" />
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">iOS</label>
                        <input type="url" class="input-field" placeholder="app200.publog.co.kr" value="${img.landingUrlIos || ''}"
                               onchange="updateImageAtIndex('${block.id}', ${i}, 'landingUrlIos', this.value, ${block.area === 'main'})" />
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">WEB</label>
                        <input type="url" class="input-field" placeholder="www.publog.co.kr" value="${img.landingUrlWeb || ''}"
                               onchange="updateImageAtIndex('${block.id}', ${i}, 'landingUrlWeb', this.value, ${block.area === 'main'})" />
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">MO</label>
                        <input type="url" class="input-field" placeholder="m.publog.co.kr" value="${img.landingUrlMo || ''}"
                               onchange="updateImageAtIndex('${block.id}', ${i}, 'landingUrlMo', this.value, ${block.area === 'main'})" />
                    </div>
                </div>
                <label class="flex items-center gap-2 cursor-pointer mt-2">
                    <label class="toggle-switch">
                        <input type="checkbox" ${img.openInNewTab ? 'checked' : ''}
                               onchange="updateImageAtIndex('${block.id}', ${i}, 'openInNewTab', this.checked, ${block.area === 'main'})" />
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="text-sm font-medium">ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°</span>
                </label>
            </div>`;
    }
    break;

            case 'button':
    html += `
        <div class="property-section">
            <label class="block text-sm font-medium mb-2">ë²„íŠ¼ í…ìŠ¤íŠ¸</label>
            <input type="text" class="input-field" value="${block.text || ''}"
                   onchange="updateBlockProperty('${block.id}', 'text', this.value, true)" />
        </div>
        <div class="property-section">
            <label class="block text-sm font-medium mb-2">ë°°ê²½ ìƒ‰ìƒ</label>
            <div class="flex gap-2">
                <input type="color" value="${block.bgColor || '#6366f1'}"
                       onchange="updateBlockProperty('${block.id}', 'bgColor', this.value, true)" />
                <input type="text" class="input-field uppercase" value="${block.bgColor || '#6366f1'}"
                       onchange="updateBlockProperty('${block.id}', 'bgColor', this.value, true)" />
            </div>
        </div>
        <div class="property-section">
            <label class="block text-sm font-medium mb-2">í…ìŠ¤íŠ¸ ìƒ‰ìƒ</label>
            <div class="flex gap-2">
                <input type="color" value="${block.textColor || '#ffffff'}"
                       onchange="updateBlockProperty('${block.id}', 'textColor', this.value, true)" />
                <input type="text" class="input-field uppercase" value="${block.textColor || '#ffffff'}"
                       onchange="updateBlockProperty('${block.id}', 'textColor', this.value, true)" />
            </div>
        </div>
        <div class="property-section">
            <label class="block text-sm font-medium mb-2">ëœë”© URL</label>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-xs text-gray-600 mb-1">AOS</label>
                    <input type="url" class="input-field" placeholder="app100.publog.co.kr" value="${block.landingUrlAos || ''}"
                           onchange="updateBlockProperty('${block.id}', 'landingUrlAos', this.value, true)" />
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">iOS</label>
                    <input type="url" class="input-field" placeholder="app200.publog.co.kr" value="${block.landingUrlIos || ''}"
                           onchange="updateBlockProperty('${block.id}', 'landingUrlIos', this.value, true)" />
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">WEB</label>
                    <input type="url" class="input-field" placeholder="www.publog.co.kr" value="${block.landingUrlWeb || ''}"
                           onchange="updateBlockProperty('${block.id}', 'landingUrlWeb', this.value, true)" />
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">MO</label>
                    <input type="url" class="input-field" placeholder="m.publog.co.kr" value="${block.landingUrlMo || ''}"
                           onchange="updateBlockProperty('${block.id}', 'landingUrlMo', this.value, true)" />
                </div>
            </div>
        </div>
        <!-- âœ… ì¶”ê°€ -->
        <div class="property-section">
            <label class="flex items-center gap-2 cursor-pointer">
                <label class="toggle-switch">
                    <input type="checkbox" ${block.openInNewTab ? 'checked' : ''} 
                           onchange="updateBlockProperty('${block.id}', 'openInNewTab', this.checked, true)" />
                    <span class="toggle-slider"></span>
                </label>
                <span class="text-sm font-medium">ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°</span>
            </label>
        </div>`;
    break;
                
            case 'banner':
    html += `
        <div class="property-section">
            <label class="block text-sm font-medium mb-2">ë©”ì¸ í…ìŠ¤íŠ¸</label>
            <input type="text" class="input-field" value="${block.mainText || ''}"
                   onchange="updateBlockProperty('${block.id}', 'mainText', this.value, true)" />
        </div>
        <div class="property-section">
            <label class="block text-sm font-medium mb-2">ì„œë¸Œ í…ìŠ¤íŠ¸</label>
            <input type="text" class="input-field" value="${block.subText || ''}"
                   onchange="updateBlockProperty('${block.id}', 'subText', this.value, true)" />
        </div>
        <div class="property-section">
            <label class="block text-sm font-medium mb-2">í…ìŠ¤íŠ¸ ì •ë ¬</label>
            <div class="flex gap-2">
                <button class="btn flex-1 ${(block.textAlign || 'left') === 'left' ? 'btn-primary' : 'btn-secondary'}"
                        onclick="updateBlockProperty('${block.id}', 'textAlign', 'left', true)">ì™¼ìª½</button>
                <button class="btn flex-1 ${block.textAlign === 'center' ? 'btn-primary' : 'btn-secondary'}"
                        onclick="updateBlockProperty('${block.id}', 'textAlign', 'center', true)">ê°€ìš´ë°</button>
                <button class="btn flex-1 ${block.textAlign === 'right' ? 'btn-primary' : 'btn-secondary'}"
                        onclick="updateBlockProperty('${block.id}', 'textAlign', 'right', true)">ì˜¤ë¥¸ìª½</button>
            </div>
        </div>
        <div class="property-section">
            <label class="block text-sm font-medium mb-2">ë°°ê²½ ìƒ‰ìƒ</label>
            <div class="flex gap-2">
                <input type="color" value="${block.bgColor || '#6366f1'}"
                       onchange="updateBlockProperty('${block.id}', 'bgColor', this.value, true)" />
                <input type="text" class="input-field uppercase" value="${block.bgColor || '#6366f1'}"
                       onchange="updateBlockProperty('${block.id}', 'bgColor', this.value, true)" />
            </div>
        </div>
        <div class="property-section">
            <label class="block text-sm font-medium mb-2">í…ìŠ¤íŠ¸ ìƒ‰ìƒ</label>
            <div class="flex gap-2">
                <input type="color" value="${block.textColor || '#ffffff'}"
                       onchange="updateBlockProperty('${block.id}', 'textColor', this.value, true)" />
                <input type="text" class="input-field uppercase" value="${block.textColor || '#ffffff'}"
                       onchange="updateBlockProperty('${block.id}', 'textColor', this.value, true)" />
            </div>
        </div>
        <div class="property-section">
            <label class="block text-sm font-medium mb-2">ëœë”© URL</label>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-xs text-gray-600 mb-1">AOS</label>
                    <input type="url" class="input-field" placeholder="app100.publog.co.kr" value="${block.landingUrlAos || ''}"
                           onchange="updateBlockProperty('${block.id}', 'landingUrlAos', this.value, true)" />
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">iOS</label>
                    <input type="url" class="input-field" placeholder="app200.publog.co.kr" value="${block.landingUrlIos || ''}"
                           onchange="updateBlockProperty('${block.id}', 'landingUrlIos', this.value, true)" />
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">WEB</label>
                    <input type="url" class="input-field" placeholder="www.publog.co.kr" value="${block.landingUrlWeb || ''}"
                           onchange="updateBlockProperty('${block.id}', 'landingUrlWeb', this.value, true)" />
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">MO</label>
                    <input type="url" class="input-field" placeholder="m.publog.co.kr" value="${block.landingUrlMo || ''}"
                           onchange="updateBlockProperty('${block.id}', 'landingUrlMo', this.value, true)" />
                </div>
            </div>
        </div>
        <!-- âœ… ì¶”ê°€ -->
        <div class="property-section">
            <label class="flex items-center gap-2 cursor-pointer">
                <label class="toggle-switch">
                    <input type="checkbox" ${block.openInNewTab ? 'checked' : ''} 
                           onchange="updateBlockProperty('${block.id}', 'openInNewTab', this.checked, true)" />
                    <span class="toggle-slider"></span>
                </label>
                <span class="text-sm font-medium">ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°</span>
            </label>
        </div>`;
    break;
                
            case 'label':
                html += `
                    <div class="property-section">
                        <label class="block text-sm font-medium mb-2">ë¼ë²¨ í…ìŠ¤íŠ¸</label>
                        <input type="text" class="input-field" value="${block.text || ''}" 
                               onchange="updateBlockProperty('${block.id}', 'text', this.value, true)" />
                    </div>
                    <div class="property-section">
                        <label class="block text-sm font-medium mb-2">ë°°ê²½ ìƒ‰ìƒ</label>
                        <div class="flex gap-2">
                            <input type="color" value="${block.bgColor || '#F5F5F5'}" 
                                   onchange="updateBlockProperty('${block.id}', 'bgColor', this.value, true)" />
                            <input type="text" class="input-field uppercase" value="${block.bgColor || '#F5F5F5'}" 
                                   onchange="updateBlockProperty('${block.id}', 'bgColor', this.value, true)" />
                        </div>
                    </div>
                    <div class="property-section">
                        <label class="block text-sm font-medium mb-2">í…ìŠ¤íŠ¸ ìƒ‰ìƒ</label>
                        <div class="flex gap-2">
                            <input type="color" value="${block.textColor || '#1C1C1C'}" 
                                   onchange="updateBlockProperty('${block.id}', 'textColor', this.value, true)" />
                            <input type="text" class="input-field uppercase" value="${block.textColor || '#1C1C1C'}" 
                                   onchange="updateBlockProperty('${block.id}', 'textColor', this.value, true)" />
                        </div>
                    </div>`;
                break;
                
            case 'callout':
                html += `
                    <div class="property-section">
                        <label class="block text-sm font-medium mb-2">ì½œì•„ì›ƒ ì œëª©</label>
                        <input type="text" class="input-field" value="${block.title || ''}" 
                               onchange="updateBlockProperty('${block.id}', 'title', this.value, true)" />
                    </div>
                    <div class="property-section">
                        <label class="block text-sm font-medium mb-2">ì½œì•„ì›ƒ ë‚´ìš©</label>
                        <textarea class="input-field" rows="3" 
                                  onchange="updateBlockProperty('${block.id}', 'content', this.value, true)">${block.content || ''}</textarea>
                    </div>
                    <div class="property-section">
                        <label class="block text-sm font-medium mb-2">ë°°ê²½ ìƒ‰ìƒ</label>
                        <div class="flex gap-2">
                            <input type="color" value="${block.bgColor || '#F5F5F5'}" 
                                   onchange="updateBlockProperty('${block.id}', 'bgColor', this.value, true)" />
                            <input type="text" class="input-field uppercase" value="${block.bgColor || '#F5F5F5'}" 
                                   onchange="updateBlockProperty('${block.id}', 'bgColor', this.value, true)" />
                        </div>
                    </div>
                    <div class="property-section">
                        <label class="block text-sm font-medium mb-2">í…ìŠ¤íŠ¸ ìƒ‰ìƒ</label>
                        <div class="flex gap-2">
                            <input type="color" value="${block.textColor || '#1C1C1C'}" 
                                   onchange="updateBlockProperty('${block.id}', 'textColor', this.value, true)" />
                            <input type="text" class="input-field uppercase" value="${block.textColor || '#1C1C1C'}" 
                                   onchange="updateBlockProperty('${block.id}', 'textColor', this.value, true)" />
                        </div>
                    </div>`;
                break;
                
            case 'listitem':
    html += `
        <div class="property-section">
            <label class="block text-sm font-medium mb-2">ì œëª©</label>
            <input type="text" class="input-field" value="${block.title || ''}"
                   onchange="updateBlockProperty('${block.id}', 'title', this.value, false)" />
        </div>
        <div class="property-section">
            <label class="block text-sm font-medium mb-2">ì†Œì œëª©</label>
            <input type="text" class="input-field" value="${block.subtitle || ''}"
                   onchange="updateBlockProperty('${block.id}', 'subtitle', this.value, false)" />
        </div>
        <div class="property-section">
            <label class="block text-sm font-medium mb-2">ëœë”© URL</label>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-xs text-gray-600 mb-1">AOS</label>
                    <input type="url" class="input-field" placeholder="app100.publog.co.kr" value="${block.landingUrlAos || ''}"
                           onchange="updateBlockProperty('${block.id}', 'landingUrlAos', this.value, false)" />
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">iOS</label>
                    <input type="url" class="input-field" placeholder="app200.publog.co.kr" value="${block.landingUrlIos || ''}"
                           onchange="updateBlockProperty('${block.id}', 'landingUrlIos', this.value, false)" />
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">WEB</label>
                    <input type="url" class="input-field" placeholder="www.publog.co.kr" value="${block.landingUrlWeb || ''}"
                           onchange="updateBlockProperty('${block.id}', 'landingUrlWeb', this.value, false)" />
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">MO</label>
                    <input type="url" class="input-field" placeholder="m.publog.co.kr" value="${block.landingUrlMo || ''}"
                           onchange="updateBlockProperty('${block.id}', 'landingUrlMo', this.value, false)" />
                </div>
            </div>
        </div>
        <div class="property-section">
            <label class="flex items-center gap-2">
                <label class="toggle-switch">
                    <input type="checkbox" ${block.showBorder ? 'checked' : ''} 
                           onchange="updateBlockProperty('${block.id}', 'showBorder', this.checked, false)" />
                    <span class="toggle-slider"></span>
                </label>
                <span class="text-sm font-medium">ì™¸ê³½ì„  í‘œì‹œ</span>
            </label>
        </div>
        <div class="property-section">
            <label class="flex items-center gap-2 cursor-pointer">
                <label class="toggle-switch">
                    <input type="checkbox" ${block.openInNewTab ? 'checked' : ''} 
                           onchange="updateBlockProperty('${block.id}', 'openInNewTab', this.checked, false)" />
                    <span class="toggle-slider"></span>
                </label>
                <span class="text-sm font-medium">ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°</span>
            </label>
        </div>`;
    break;
                
            case 'spacer':
                html += `
                    <div class="property-section">
                        <label class="block text-sm font-medium mb-2">ë†’ì´ (px)</label>
                        <input type="number" class="input-field" value="${block.height || 20}" min="0" max="200"
                               onchange="updateBlockProperty('${block.id}', 'height', parseInt(this.value), ${block.area === 'main'})" />
                    </div>`;
                break;
                
            case 'divider':
                html += `
                    <div class="property-section">
                        <p class="text-sm text-gray-600">êµ¬ë¶„ì„ ì€ ë³„ë„ ì„¤ì •ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>`;
                break;
        }
        
        // ì‚­ì œ ë²„íŠ¼
        html += `
          <div style="padding-top: 20px; border-top: 1px solid #e5e5e5; margin-top: 20px;">
              <button class="btn btn-secondary w-full text-red-600 hover:bg-red-50" 
                        onclick="deleteSelectedBlock()">
                    <svg class="w-4 h-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    ë¸”ë¡ ì‚­ì œ
                </button>
            </div>`;
        
        html += `</div>`;
        propertiesContent.innerHTML = html;
    }

    // ë¸”ë¡ ì†ì„± ì—…ë°ì´íŠ¸
        function updateBlockProperty(blockId, property, value, isMain) {
            const blockArray = isMain ? blocks : sidebarBlocks;
            const result = findBlockRecursively(blockId, blockArray);
            if (result && result.block) {
                result.block[property] = value;
                editor.saveState();
                if (isMain) {
                    renderCanvas();
                } else {
                    renderSidebar();
                }
                // ì†ì„± íŒ¨ë„ ë‹¤ì‹œ ì„ íƒ
                selectBlock(blockId, isMain);
            }
        }

        // ì´ë¯¸ì§€ ì†ì„± ì—…ë°ì´íŠ¸ (2ë¶„í• ìš©)
        function updateImageProperty(blockId, imageSide, property, value, isMain) {
            const blockArray = isMain ? blocks : sidebarBlocks;
            const result = findBlockRecursively(blockId, blockArray);
            if (result && result.block) {
                if (!result.block[imageSide]) result.block[imageSide] = {};
                result.block[imageSide][property] = value;
                editor.saveState();
                if (isMain) {
                    renderCanvas();
                } else {
                    renderSidebar();
                }
                selectBlock(blockId, isMain);
            }
        }

        // ì´ë¯¸ì§€ ë¶„í•  ê°œìˆ˜ ë³€ê²½
        function changeImageCount(blockId, count, isMain) {
            const blockArray = isMain ? blocks : sidebarBlocks;
            const result = findBlockRecursively(blockId, blockArray);
            if (result && result.block) {
                result.block.imageCount = count;

                // images ë°°ì—´ ì´ˆê¸°í™” ë° í¬ê¸° ì¡°ì •
                if (!result.block.images) result.block.images = [];
                while (result.block.images.length < count) {
                    result.block.images.push({
                        url: `https://placehold.co/300x400/6366f1/ffffff?text=Image+${result.block.images.length + 1}`,
                        caption: '',
                        landingUrl: '',
                        landingUrlAos: '',
                        landingUrlIos: '',
                        landingUrlWeb: '',
                        landingUrlMo: '',
                        openInNewTab: false
                    });
                }

                editor.saveState();
                if (isMain) {
                    renderCanvas();
                } else {
                    renderSidebar();
                }
                selectBlock(blockId, isMain);
            }
        }

        // íŠ¹ì • ì¸ë±ìŠ¤ì˜ ì´ë¯¸ì§€ ì†ì„± ì—…ë°ì´íŠ¸
        function updateImageAtIndex(blockId, index, property, value, isMain) {
            const blockArray = isMain ? blocks : sidebarBlocks;
            const result = findBlockRecursively(blockId, blockArray);
            if (result && result.block && result.block.images && result.block.images[index]) {
                result.block.images[index][property] = value;
                editor.saveState();
                if (isMain) {
                    renderCanvas();
                } else {
                    renderSidebar();
                }
                selectBlock(blockId, isMain);
            }
        }

        // ì´ë¯¸ì§€ 2ë¶„í•  í† ê¸€ (í•˜ìœ„ í˜¸í™˜ì„±ìš© - ë” ì´ìƒ ì‚¬ìš© ì•ˆí•¨)
        function toggleImageSplit(blockId, isSplit, isMain) {
            changeImageCount(blockId, isSplit ? 2 : 1, isMain);
        }

        // ì—´ ê°œìˆ˜ ë³€ê²½
        function changeColumnCount(blockId, count, isMain) {
            const blockArray = isMain ? blocks : sidebarBlocks;
            const result = findBlockRecursively(blockId, blockArray);
            if (result && result.block) {
                result.block.columnCount = count;

                // columns ë°°ì—´ ì´ˆê¸°í™” ë° í¬ê¸° ì¡°ì • (ê° ì—´ì€ ë¸”ë¡ ë°°ì—´)
                if (!result.block.columns) result.block.columns = [];
                while (result.block.columns.length < count) {
                    result.block.columns.push([]); // ë¹ˆ ë¸”ë¡ ë°°ì—´
                }

                editor.saveState();
                if (isMain) {
                    renderCanvas();
                } else {
                    renderSidebar();
                }
                selectBlock(blockId, isMain);
            }
        }

    // ì„ íƒëœ ë¸”ë¡ ì‚­ì œ
    function deleteSelectedBlock() {
        if (!selectedBlock) return;

        // ì—´ ë‚´ë¶€ ë¸”ë¡ì¸ ê²½ìš°
        if (selectedBlock.parent && selectedBlock.columnIndex !== null) {
            const parent = selectedBlock.parent;
            if (parent.columns && parent.columns[selectedBlock.columnIndex]) {
                parent.columns[selectedBlock.columnIndex] = parent.columns[selectedBlock.columnIndex].filter(
                    b => b.id !== selectedBlock.id
                );
            }
        } else {
            // ì¼ë°˜ ë¸”ë¡ì¸ ê²½ìš°
            if (selectedBlock.isMain) {
                blocks = blocks.filter(b => b.id !== selectedBlock.id);
            } else {
                sidebarBlocks = sidebarBlocks.filter(b => b.id !== selectedBlock.id);
            }
        }

        if (selectedBlock.isMain) {
            renderCanvas();
        } else {
            renderSidebar();
        }

        selectedBlock = null;
        updatePropertiesPanel(null);
        editor.saveState();
    }

    // ë¸”ë¡ ë Œë”ë§
    const renderBlock = (block, container, area) => {
        const blockEl = document.createElement('div');
        blockEl.className = 'block-container';
        blockEl.setAttribute('data-id', block.id);
        blockEl.setAttribute('draggable', true);
        
        // ì„ íƒ ì´ë²¤íŠ¸
        blockEl.addEventListener('click', (e) => {
            if (!e.target.closest('.text-block')) {
                selectBlock(block.id, area === 'main');
            }
        });
        
        const dragHandle = `
            <div class="drag-handle absolute -left-8 top-2 p-1 rounded cursor-grab hover:bg-gray-200">
                <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </div>`;
        
        let contentHTML = '';
        
        switch (block.type) {
            case 'text':
            blockEl.innerHTML = `
                ${dragHandle}
                <div contenteditable="true" class="text-block exported-font min-h-[1.5em] focus:outline-none rounded-md transition-all text-left" style="margin-bottom: 12px; padding: 0;">${block.content}</div>`;
                blockEl.querySelector('.text-block').addEventListener('input', (e) => {
                    block.content = e.target.innerHTML;
                    clearTimeout(block.saveTimer);
                    block.saveTimer = setTimeout(editor.saveState, 1000);
                });
                return blockEl;
            case 'columns':
            const columnCount = block.columnCount || 2;
            const columns = block.columns || [[], [], [], []];
            const isLocked = block.isLocked || false;

            // ê° ì—´ì„ ë Œë”ë§
            contentHTML = `
                ${dragHandle}
                <div class="columns-container" style="display: flex; gap: 16px; margin: 12px 0; align-items: flex-start;"></div>`;

            blockEl.innerHTML = contentHTML;
            const columnsContainer = blockEl.querySelector('.columns-container');

            for (let i = 0; i < columnCount; i++) {
                const columnEl = document.createElement('div');
                columnEl.className = 'column-drop-zone';
                columnEl.setAttribute('data-column-index', i);
                columnEl.setAttribute('data-parent-block-id', block.id);
                columnEl.style.cssText = 'flex: 1; min-height: 120px; padding: 12px; border: 2px dashed #d4d4d4; border-radius: 6px; background: #fafafa;';

                const columnBlocks = columns[i] || [];

                if (columnBlocks.length === 0) {
                    // ë¹ˆ ì—´ì—ëŠ” placeholder
                    columnEl.innerHTML = `
                        <div style="text-align: center; color: #999; padding: 20px; font-size: 13px; pointer-events: none;">
                            <svg style="width: 32px; height: 32px; margin: 0 auto 8px; opacity: 0.3;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            <div>${isLocked ? 'ë‚´ë¶€ ë¸”ë¡ì„ ë“œë˜ê·¸í•˜ì„¸ìš”' : 'ì—´ì„ í™•ì •í•œ í›„ ë¸”ë¡ì„ ë“œë˜ê·¸í•˜ì„¸ìš”'}</div>
                        </div>`;
                } else {
                    // ì—´ ë‚´ë¶€ ë¸”ë¡ë“¤ ë Œë”ë§
                    columnBlocks.forEach(colBlock => {
                        const innerBlockEl = renderBlock(colBlock, columnEl, area);
                        // isLockedì— ë”°ë¼ ë‚´ë¶€ ë¸”ë¡ ì„ íƒ ê°€ëŠ¥ ì—¬ë¶€ ì œì–´
                        if (!isLocked) {
                            innerBlockEl.style.pointerEvents = 'none';
                            innerBlockEl.style.opacity = '0.6';
                        }
                        columnEl.appendChild(innerBlockEl);
                    });
                }

                columnsContainer.appendChild(columnEl);

                // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ì¶”ê°€ (í™•ì •ëœ ê²½ìš°ì—ë§Œ)
                if (isLocked) {
                    addColumnDropListeners(columnEl, block, i, area === 'main');
                }
            }

            return blockEl;
            case 'toggle':
        blockEl.innerHTML = `
            ${dragHandle}
            <div class="toggle-block-wrapper" style="margin: 8px 0;">
                <div class="toggle-header" style="padding: 6px 0; display: flex; align-items: flex-start; gap: 6px; cursor: pointer;">
                    <svg class="toggle-icon" style="width: 14px; height: 14px; flex-shrink: 0; transition: transform 0.2s; margin-top: 5px; color: #6b7280;" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M6 4l6 4-6 4V4z"/>
                    </svg>
                    <div contenteditable="true" class="text-block toggle-title exported-font" style="flex: 1; min-height: 1.5em; outline: none; font-size: 14px; font-weight: 400;">${block.title}</div>
                </div>
                <div class="toggle-content" style="padding-left: 20px; margin-top: 2px;">
                    <div contenteditable="true" class="text-block toggle-body exported-font" style="min-height: 1.5em; outline: none; font-size: 14px;">${block.content}</div>
                </div>
            </div>`;
        
        const titleEl = blockEl.querySelector('.toggle-title');
        titleEl.addEventListener('input', (e) => {
            block.title = e.target.innerHTML;
            clearTimeout(block.saveTimer);
            block.saveTimer = setTimeout(editor.saveState, 1000);
        });
        
        const contentEl = blockEl.querySelector('.toggle-body');
        contentEl.addEventListener('input', (e) => {
            block.content = e.target.innerHTML;
            clearTimeout(block.saveTimer);
            block.saveTimer = setTimeout(editor.saveState, 1000);
        });
        
        const toggleHeader = blockEl.querySelector('.toggle-header');
        const toggleContentDiv = blockEl.querySelector('.toggle-content');
        const toggleIcon = blockEl.querySelector('.toggle-icon');
        
        toggleHeader.addEventListener('click', (e) => {
            if (e.target.closest('.toggle-title')) return;
            
            const isOpen = toggleContentDiv.style.display !== 'none';
            toggleContentDiv.style.display = isOpen ? 'none' : 'block';
            toggleIcon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(90deg)';
            block.isOpen = !isOpen;
        });
        
        if (!block.isOpen) {
            toggleContentDiv.style.display = 'none';
            toggleIcon.style.transform = 'rotate(0deg)';
        } else {
            toggleIcon.style.transform = 'rotate(90deg)';
        }
        
        return blockEl;   
            case 'image':
    // í•˜ìœ„ í˜¸í™˜ì„±: isSplitì´ ìˆìœ¼ë©´ imageCountë¡œ ë³€í™˜
    if (block.isSplit && !block.imageCount) {
        block.imageCount = 2;
    }
    if (block.leftImage && block.rightImage && !block.images) {
        block.images = [block.leftImage, block.rightImage];
        block.imageCount = 2;
    }
    // í•˜ìœ„ í˜¸í™˜ì„±: urlì´ ìˆê³  imagesê°€ ì—†ìœ¼ë©´ ë³€í™˜
    if (block.url && !block.images) {
        block.images = [{
            url: block.url,
            caption: block.caption || '',
            landingUrl: block.landingUrl || '',
            landingUrlAos: block.landingUrlAos || '',
            landingUrlIos: block.landingUrlIos || '',
            landingUrlWeb: block.landingUrlWeb || '',
            landingUrlMo: block.landingUrlMo || '',
            openInNewTab: block.openInNewTab || false
        }];
        block.imageCount = 1;
    }

    const count = block.imageCount || 1;
    const images = block.images || [];

    if (count === 1) {
        // ë‹¨ì¼ ì´ë¯¸ì§€
        const img = images[0] || {};
        const landingUrl = getLandingUrl({landingUrlAos: img.landingUrlAos, landingUrlIos: img.landingUrlIos, landingUrlWeb: img.landingUrlWeb, landingUrlMo: img.landingUrlMo, landingUrl: img.landingUrl});
        const target = (img.openInNewTab ?? false) ? ' target="_blank"' : '';

        const imgHTML = landingUrl ?
            `<a href="${landingUrl}"${target} style="display: block;">
                <img src="${img.url || 'https://placehold.co/600x400/e5e5e5/999999?text=Image'}"
                     alt="${(img.caption || '').replace(/<[^>]*>/g, '')}"
                     style="width: 100%; border-radius: 0; box-shadow: none;"
                     onerror="this.src='https://placehold.co/600x400/e5e5e5/999999?text=Image+Error'" />
            </a>` :
            `<img src="${img.url || 'https://placehold.co/600x400/e5e5e5/999999?text=Image'}"
                 alt="${(img.caption || '').replace(/<[^>]*>/g, '')}"
                 style="width: 100%; border-radius: 0; box-shadow: none;"
                 onerror="this.src='https://placehold.co/600x400/e5e5e5/999999?text=Image+Error'" />`;

        contentHTML = `
            ${dragHandle}
            <div class="flex flex-col items-center" style="margin: 20px 0; text-align: center;">
                ${imgHTML}
                <div contenteditable="true" class="text-block image-caption-editor exported-font"
                     data-block-id="${block.id}" data-image-index="0"
                     style="font-size: 14px; color: #666; margin-top: 8px; min-height: 1em; outline: none; cursor: text;">${img.caption || '<p style="font-size: 14px; color: #666;">ìº¡ì…˜ì„ ì…ë ¥í•˜ì„¸ìš”</p>'}</div>
            </div>`;

        // ìº¡ì…˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ë‚˜ì¤‘ì— ì¶”ê°€
        blockEl.innerHTML = contentHTML;
        const captionEl = blockEl.querySelector('.image-caption-editor');
        if (captionEl) {
            captionEl.addEventListener('input', (e) => {
                if (!block.images[0]) block.images[0] = {};
                block.images[0].caption = e.target.innerHTML;
                clearTimeout(block.saveTimer);
                block.saveTimer = setTimeout(editor.saveState, 1000);
            });
            captionEl.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        return blockEl;
    } else {
        // 2~4ë¶„í•  ì´ë¯¸ì§€
        let imagesHTML = '';
        for (let i = 0; i < count; i++) {
            const img = images[i] || {};
            const landingUrl = getLandingUrl({landingUrlAos: img.landingUrlAos, landingUrlIos: img.landingUrlIos, landingUrlWeb: img.landingUrlWeb, landingUrlMo: img.landingUrlMo, landingUrl: img.landingUrl});
            const target = (img.openInNewTab ?? false) ? ' target="_blank"' : '';

            const imgHTML = landingUrl ?
                `<a href="${landingUrl}"${target} style="display: block;">
                    <img src="${img.url || `https://placehold.co/300x400/e5e5e5/999999?text=Image+${i+1}`}"
                         alt="${(img.caption || '').replace(/<[^>]*>/g, '')}"
                         style="width: 100%; border-radius: 0; box-shadow: none;"
                         onerror="this.src='https://placehold.co/300x400/e5e5e5/999999?text=Image+Error'" />
                </a>` :
                `<img src="${img.url || `https://placehold.co/300x400/e5e5e5/999999?text=Image+${i+1}`}"
                     alt="${(img.caption || '').replace(/<[^>]*>/g, '')}"
                     style="width: 100%; border-radius: 0; box-shadow: none;"
                     onerror="this.src='https://placehold.co/300x400/e5e5e5/999999?text=Image+Error'" />`;

            imagesHTML += `
                <div style="flex: 1; text-align: center;">
                    ${imgHTML}
                    <div contenteditable="true" class="text-block image-caption-editor exported-font"
                         data-block-id="${block.id}" data-image-index="${i}"
                         style="font-size: 14px; color: #666; margin-top: 8px; min-height: 1em; outline: none; cursor: text;">${img.caption || '<p style="font-size: 14px; color: #666;">ìº¡ì…˜ ' + (i + 1) + '</p>'}</div>
                </div>`;
        }

        contentHTML = `
            ${dragHandle}
            <div class="image-split-container" style="display: flex; gap: 16px; margin: 20px 0;">
                ${imagesHTML}
            </div>`;

        // ìº¡ì…˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        blockEl.innerHTML = contentHTML;
        blockEl.querySelectorAll('.image-caption-editor').forEach(captionEl => {
            const imageIndex = parseInt(captionEl.getAttribute('data-image-index'));
            captionEl.addEventListener('input', (e) => {
                if (!block.images[imageIndex]) block.images[imageIndex] = {};
                block.images[imageIndex].caption = e.target.innerHTML;
                clearTimeout(block.saveTimer);
                block.saveTimer = setTimeout(editor.saveState, 1000);
            });
            captionEl.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        });
        return blockEl;
    }
    break;
                
            case 'divider':
                contentHTML = `
                    ${dragHandle}
                    <div class="w-full border-t border-gray-200 my-4"></div>`;
                break;
                
            case 'spacer':
                contentHTML = `
                    ${dragHandle}
                    <div style="height:${block.height || 20}px;" class="w-full bg-gray-50 rounded-md border border-dashed border-gray-200 flex items-center justify-center text-xs text-gray-400">
                        ê³µë°±: ${block.height || 20}px
                    </div>`;
                break;
                
            case 'button':
    const btnStyle = `background-color:${block.bgColor || '#6366f1'}; color:${block.textColor || '#ffffff'};`;
    contentHTML = `
        ${dragHandle}
        <div class="text-center py-4">
            <span style="${btnStyle}" class="inline-block px-6 py-3 rounded-full font-semibold text-center exported-font cursor-pointer hover:opacity-90 transition" style="width: 25%; min-width: 150px;">
                ${block.text || 'ë²„íŠ¼ í…ìŠ¤íŠ¸'}
            </span>
        </div>`;
    break;
                
            case 'banner':
    const bannerAlign = block.textAlign || 'left';
    const bannerStyle = `background-color:${block.bgColor || '#6366f1'}; color:${block.textColor || '#ffffff'}; text-align:${bannerAlign};`;
    contentHTML = `
        ${dragHandle}
        <div class="rounded-xl exported-font cursor-pointer hover:opacity-95 transition" style="${bannerStyle}; padding: 18px 24px; margin: 24px 0;">
            <p class="text-sm opacity-80" style="margin: 0 0 8px 0; font-size: 14px;">${block.subText || 'ì„œë¸Œ í…ìŠ¤íŠ¸'}</p>
            <p class="font-bold" style="margin: 0; font-size: 18px; font-weight: 700;">${block.mainText || 'ë©”ì¸ í…ìŠ¤íŠ¸'}</p>
        </div>`;
    break;
                
            case 'label':
                const labelStyle = `background-color:${block.bgColor || '#F5F5F5'}; color:${block.textColor || '#1C1C1C'};`;
                contentHTML = `
                    ${dragHandle}
                    <div class="flex items-center gap-2" style="margin: 0 0 12px 0;">
                        <span style="${labelStyle}; padding: 4px 12px; font-size: 0.875em; font-weight: 500;" class="inline-block rounded-full exported-font">
                            ${block.text || 'ë¼ë²¨'}
                        </span>
                    </div>`;
                break;
                
            case 'callout':
                const calloutStyle = `background-color:${block.bgColor || '#F5F5F5'}; color:${block.textColor || '#1C1C1C'};`;
                contentHTML = `
                    ${dragHandle}
                    <div class="callout-box exported-font rounded-lg" style="${calloutStyle}; padding: 28px; margin: 20px 0;">
                        <div class="font-semibold" style="margin-bottom: 8px; font-size: 16px;">${block.title || 'ì½œì•„ì›ƒ ì œëª©'}</div>
                        <div class="opacity-90" style="white-space: pre-wrap; font-size: 16px; line-height: 1.8;">${block.content || 'ì½œì•„ì›ƒ ë‚´ìš©ì…ë‹ˆë‹¤.'}</div>
                    </div>`;
                break;
                
            case 'listitem':
    const borderClass = block.showBorder ? 'border border-gray-200' : '';
    const padding = block.showBorder ? 'p-3' : 'py-3';
    contentHTML = `
        ${dragHandle}
        <div class="list-item-block ${borderClass} ${padding} rounded-lg mb-2 hover:bg-gray-50 transition cursor-pointer">
            <p class="text-sm font-semibold text-gray-900 mb-1">${block.title || 'ë¦¬ìŠ¤íŠ¸ ì œëª©'}</p>
            <p class="text-xs text-gray-500">${block.subtitle || 'ë¦¬ìŠ¤íŠ¸ ì†Œì œëª©'}</p>
        </div>`;
    break;
        }
        
        blockEl.innerHTML = contentHTML;
        return blockEl;
    };

    // ìº”ë²„ìŠ¤ ë Œë”ë§
    const renderCanvas = () => {
        if (blocks.length === 0) {
            canvas.innerHTML = `
                <div class="text-center text-gray-400 py-20">
                    <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <h3 class="text-lg font-semibold mb-2" style="font-family: 'Pretendard', sans-serif;">ë¸”ë¡ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</h3>
                    <p class="text-sm" style="font-family: 'Pretendard', sans-serif;">ì½˜í…ì¸  ë³¸ë¬¸ ì˜ì—­ì…ë‹ˆë‹¤</p>
                </div>`;
        } else {
            canvas.innerHTML = '';
            blocks.forEach(block => {
                canvas.appendChild(renderBlock(block, canvas, 'main'));
            });
        }
        addDragAndDropListeners(canvas, blocks, 'main');
    };

    // ì‚¬ì´ë“œë°” ë Œë”ë§
    const renderSidebar = () => {
        if (sidebarBlocks.length === 0) {
            if (currentView === 'desktop') {
                sidebarCanvas.style.display = 'none';
                verticalDivider.style.display = 'none';
            }
            sidebarCanvas.innerHTML = `
                <div class="text-center text-gray-400 py-20">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                    <h4 class="text-sm font-semibold mb-1" style="font-family: 'Pretendard', sans-serif;">ë¦¬ìŠ¤íŠ¸ ì˜ì—­</h4>
                    <p class="text-xs" style="font-family: 'Pretendard', sans-serif;">ë¦¬ìŠ¤íŠ¸ ë¸”ë¡ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                </div>`;
        } else {
            sidebarCanvas.style.display = 'block';
            if (currentView === 'desktop') {
                verticalDivider.style.display = 'flex';
            }
            sidebarCanvas.innerHTML = '';
            sidebarBlocks.forEach(block => {
                sidebarCanvas.appendChild(renderBlock(block, sidebarCanvas, 'sidebar'));
            });
        }
        addDragAndDropListeners(sidebarCanvas, sidebarBlocks, 'sidebar');
    };
      // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¦¬ìŠ¤ë„ˆ
    let draggedEl = null;
    const addDragAndDropListeners = (container, blockArray, area) => {
        container.querySelectorAll('.block-container').forEach(el => {
            el.addEventListener('dragstart', (e) => {
                draggedEl = el;
                setTimeout(() => el.style.opacity = '0.4', 0);
            });
            
            el.addEventListener('dragend', () => {
                if (draggedEl) {
                    draggedEl.style.opacity = '1';
                    draggedEl = null;
                }
                container.querySelectorAll('.block-container').forEach(x => {
                    x.classList.remove('border-t-2', 'border-b-2', 'border-indigo-500');
                });
            });
            
            el.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (draggedEl && draggedEl !== el) {
                    const rect = el.getBoundingClientRect();
                    const after = (e.clientY - rect.top) / rect.height > 0.5;
                    container.querySelectorAll('.block-container').forEach(x => {
                        x.classList.remove('border-t-2', 'border-b-2', 'border-indigo-500');
                    });
                    el.classList.add(after ? 'border-b-2' : 'border-t-2', 'border-indigo-500');
                }
            });
            
            el.addEventListener('dragleave', () => {
                el.classList.remove('border-t-2', 'border-b-2', 'border-indigo-500');
            });
            
            el.addEventListener('drop', (e) => {
                e.preventDefault();
                el.classList.remove('border-t-2', 'border-b-2', 'border-indigo-500');
                if (!draggedEl) return;
                
                const droppedId = el.getAttribute('data-id');
                const draggedId = draggedEl.getAttribute('data-id');
                const di = blockArray.findIndex(b => b.id === droppedId);
                const si = blockArray.findIndex(b => b.id === draggedId);
                
                if (si === -1) return;
                
                const movedBlock = blockArray.splice(si, 1)[0];
                const rect = el.getBoundingClientRect();
                const after = (e.clientY - rect.top) / rect.height > 0.5;
                blockArray.splice(di + (after ? 1 : 0), 0, movedBlock);
                
                editor.saveState();
                if (area === 'sidebar') renderSidebar();
                else renderCanvas();
            });
        });
    };

    // ì—´ ë‚´ë¶€ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¦¬ìŠ¤ë„ˆ
    const addColumnDropListeners = (columnEl, parentBlock, columnIndex, isMain) => {
        // ì—´ ë‚´ë¶€ ë¸”ë¡ë“¤ì— ë“œë˜ê·¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        columnEl.querySelectorAll('.block-container').forEach(el => {
            el.addEventListener('dragstart', (e) => {
                draggedEl = el;
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => el.style.opacity = '0.4', 0);
            });

            el.addEventListener('dragend', () => {
                if (draggedEl) {
                    draggedEl.style.opacity = '1';
                    draggedEl = null;
                }
            });
        });

        // ì—´ì— ë“œë˜ê·¸ ì˜¤ë²„
        columnEl.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            columnEl.style.borderColor = '#6366f1';
            columnEl.style.background = '#f5f5ff';
        });

        // ì—´ì—ì„œ ë“œë˜ê·¸ ë‚˜ê°
        columnEl.addEventListener('dragleave', (e) => {
            if (e.target === columnEl) {
                columnEl.style.borderColor = '#d4d4d4';
                columnEl.style.background = '#fafafa';
            }
        });

        // ì—´ì— ë“œë¡­
        columnEl.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            columnEl.style.borderColor = '#d4d4d4';
            columnEl.style.background = '#fafafa';

            try {
                // ë¸”ë¡ ë„êµ¬ì—ì„œ ë“œë˜ê·¸í•œ ê²½ìš°
                const data = e.dataTransfer.getData('text/plain');
                if (data) {
                    const parsedData = JSON.parse(data);
                    if (parsedData.type) {
                        const newBlock = createNewBlock(parsedData.type, isMain ? 'main' : 'sidebar');

                        if (!parentBlock.columns[columnIndex]) {
                            parentBlock.columns[columnIndex] = [];
                        }

                        parentBlock.columns[columnIndex].push(newBlock);
                        editor.saveState();

                        if (isMain) renderCanvas();
                        else renderSidebar();
                    }
                }
            } catch (err) {
                console.log('Column drop error:', err);
            }
        });
    };

    // ë¸”ë¡ ë„êµ¬ ë“œë˜ê·¸
    document.querySelectorAll('.block-item').forEach(tool => {
        tool.addEventListener('dragstart', (e) => {
            const type = e.target.closest('.block-item').getAttribute('data-type');
            const area = e.target.closest('.block-item').getAttribute('data-area');
            e.dataTransfer.setData('text/plain', JSON.stringify({
                type: type,
                area: area || 'both'
            }));
            e.dataTransfer.effectAllowed = 'copy';
        });
    });

// ìº”ë²„ìŠ¤ ë“œë¡­ ì´ë²¤íŠ¸
canvas.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
    
    // âœ… ë“œë˜ê·¸ ì˜¤ë²„ ì‹œ ì‚½ì… ìœ„ì¹˜ í‘œì‹œ
    const blockContainers = canvas.querySelectorAll('.block-container');
    blockContainers.forEach(container => {
        const rect = container.getBoundingClientRect();
        const isAfter = (e.clientY - rect.top) / rect.height > 0.5;
        container.classList.remove('border-t-2', 'border-b-2', 'border-indigo-500');
        if (e.clientY >= rect.top && e.clientY <= rect.bottom) {
            container.classList.add(isAfter ? 'border-b-2' : 'border-t-2', 'border-indigo-500');
        }
    });
});

// âœ… ìº”ë²„ìŠ¤ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ í‘œì‹œ ì œê±°
canvas.addEventListener('dragleave', (e) => {
    if (e.target === canvas) {
        canvas.querySelectorAll('.block-container').forEach(el => {
            el.classList.remove('border-t-2', 'border-b-2', 'border-indigo-500');
        });
    }
});

canvas.addEventListener('drop', (e) => {
    e.preventDefault();
    
    // âœ… ì‚½ì… ìœ„ì¹˜ í‘œì‹œ ì œê±°
    canvas.querySelectorAll('.block-container').forEach(el => {
        el.classList.remove('border-t-2', 'border-b-2', 'border-indigo-500');
    });
    
    try {
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        if (data && (data.area === 'main' || data.area === 'both')) {
            const newBlock = createNewBlock(data.type, 'main');
            
            // âœ… ë“œë¡­ ìœ„ì¹˜ ê³„ì‚°
            let insertIndex = blocks.length; // ê¸°ë³¸ê°’: ë§¨ ë
            
            const blockContainers = canvas.querySelectorAll('.block-container');
            for (let i = 0; i < blockContainers.length; i++) {
                const container = blockContainers[i];
                const rect = container.getBoundingClientRect();
                
                if (e.clientY >= rect.top && e.clientY <= rect.bottom) {
                    const isAfter = (e.clientY - rect.top) / rect.height > 0.5;
                    insertIndex = isAfter ? i + 1 : i;
                    break;
                } else if (e.clientY < rect.top) {
                    insertIndex = i;
                    break;
                }
            }
            
            // âœ… ê³„ì‚°ëœ ìœ„ì¹˜ì— ë¸”ë¡ ì‚½ì…
            blocks.splice(insertIndex, 0, newBlock);
            editor.saveState();
            renderCanvas();
        }
    } catch (err) {
        console.error('Drop error:', err);
    }
});

// ì‚¬ì´ë“œë°” ë“œë¡­ ì´ë²¤íŠ¸
sidebarCanvas.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
    
    // âœ… ë“œë˜ê·¸ ì˜¤ë²„ ì‹œ ì‚½ì… ìœ„ì¹˜ í‘œì‹œ
    const blockContainers = sidebarCanvas.querySelectorAll('.block-container');
    blockContainers.forEach(container => {
        const rect = container.getBoundingClientRect();
        const isAfter = (e.clientY - rect.top) / rect.height > 0.5;
        container.classList.remove('border-t-2', 'border-b-2', 'border-indigo-500');
        if (e.clientY >= rect.top && e.clientY <= rect.bottom) {
            container.classList.add(isAfter ? 'border-b-2' : 'border-t-2', 'border-indigo-500');
        }
    });
});

// âœ… ì‚¬ì´ë“œë°” ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ í‘œì‹œ ì œê±°
sidebarCanvas.addEventListener('dragleave', (e) => {
    if (e.target === sidebarCanvas) {
        sidebarCanvas.querySelectorAll('.block-container').forEach(el => {
            el.classList.remove('border-t-2', 'border-b-2', 'border-indigo-500');
        });
    }
});

sidebarCanvas.addEventListener('drop', (e) => {
    e.preventDefault();
    
    // âœ… ì‚½ì… ìœ„ì¹˜ í‘œì‹œ ì œê±°
    sidebarCanvas.querySelectorAll('.block-container').forEach(el => {
        el.classList.remove('border-t-2', 'border-b-2', 'border-indigo-500');
    });
    
    try {
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        if (data && (data.area === 'sidebar' || data.area === 'both')) {
            const newBlock = createNewBlock(data.type, 'sidebar');
            
            // âœ… ë“œë¡­ ìœ„ì¹˜ ê³„ì‚°
            let insertIndex = sidebarBlocks.length; // ê¸°ë³¸ê°’: ë§¨ ë
            
            const blockContainers = sidebarCanvas.querySelectorAll('.block-container');
            for (let i = 0; i < blockContainers.length; i++) {
                const container = blockContainers[i];
                const rect = container.getBoundingClientRect();
                
                if (e.clientY >= rect.top && e.clientY <= rect.bottom) {
                    const isAfter = (e.clientY - rect.top) / rect.height > 0.5;
                    insertIndex = isAfter ? i + 1 : i;
                    break;
                } else if (e.clientY < rect.top) {
                    insertIndex = i;
                    break;
                }
            }
            
            // âœ… ê³„ì‚°ëœ ìœ„ì¹˜ì— ë¸”ë¡ ì‚½ì…
            sidebarBlocks.splice(insertIndex, 0, newBlock);
            editor.saveState();
            renderSidebar();
        }
    } catch (err) {
        console.error('Drop error:', err);
    }
});

   // ìƒˆ ë¸”ë¡ ìƒì„±
const createNewBlock = (type, area) => {
    const id = generateUUID();
    
    if (area === 'sidebar' && type === 'listitem') {
        return {
            id,
            type,
            area: 'sidebar',
            title: 'ë¦¬ìŠ¤íŠ¸ ì œëª©',
            subtitle: 'ë¦¬ìŠ¤íŠ¸ ì†Œì œëª©',
            landingUrl: '',
            landingUrlAos: '',
            landingUrlIos: '',
            landingUrlWeb: '',
            landingUrlMo: '',
            showBorder: false,
            openInNewTab: false
        };
    }
    
    switch(type) {
        case 'text':
            return { id, type, area, content: '<p style="font-size: 16px;">ìƒˆ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>' };
        case 'columns':
            return {
                id,
                type,
                area,
                columnCount: 2, // 1, 2, 3, 4 ì¤‘ ì„ íƒ
                isLocked: false, // false: ì—´ ê°œìˆ˜ í¸ì§‘, true: ë‚´ë¶€ ë¸”ë¡ í¸ì§‘
                columns: [
                    [], // ê° ì—´ì€ ë¸”ë¡ ë°°ì—´
                    [],
                    [],
                    []
                ]
            };
        case 'image':
            return {
                id,
                type,
                area,
                imageCount: 1, // 1, 2, 3, 4 ì¤‘ ì„ íƒ
                images: [
                    {
                        url: 'https://placehold.co/600x400/6366f1/ffffff?text=Image+1',
                        caption: '',
                        landingUrl: '',
                        landingUrlAos: '',
                        landingUrlIos: '',
                        landingUrlWeb: '',
                        landingUrlMo: '',
                        openInNewTab: false
                    },
                    {
                        url: 'https://placehold.co/300x400/6366f1/ffffff?text=Image+2',
                        caption: '',
                        landingUrl: '',
                        landingUrlAos: '',
                        landingUrlIos: '',
                        landingUrlWeb: '',
                        landingUrlMo: '',
                        openInNewTab: false
                    },
                    {
                        url: 'https://placehold.co/300x400/6366f1/ffffff?text=Image+3',
                        caption: '',
                        landingUrl: '',
                        landingUrlAos: '',
                        landingUrlIos: '',
                        landingUrlWeb: '',
                        landingUrlMo: '',
                        openInNewTab: false
                    },
                    {
                        url: 'https://placehold.co/300x400/6366f1/ffffff?text=Image+4',
                        caption: '',
                        landingUrl: '',
                        landingUrlAos: '',
                        landingUrlIos: '',
                        landingUrlWeb: '',
                        landingUrlMo: '',
                        openInNewTab: false
                    }
                ]
            };
        case 'toggle':
            return { 
                id, 
                type, 
                area, 
                title: '<p style="font-size: 14px;">í† ê¸€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”</p>',
                content: '<p style="font-size: 14px;">í† ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. í´ë¦­í•˜ë©´ í¼ì³ì§€ê³  ì ‘í™ë‹ˆë‹¤.</p>',
                isOpen: false
            };
        case 'divider':
            return { id, type, area };
        case 'spacer':
            return { id, type, area, height: 20 };
        case 'button':
            return { id, type, area, text: 'í´ë¦­í•˜ê¸°', bgColor: '#6366f1', textColor: '#ffffff', landingUrl: '', landingUrlAos: '', landingUrlIos: '', landingUrlWeb: '', landingUrlMo: '', openInNewTab: false };
        case 'banner':
            return { id, type, area, mainText: 'ë°°ë„ˆ íƒ€ì´í‹€', subText: 'ë°°ë„ˆ ì„œë¸Œíƒ€ì´í‹€', bgColor: '#6366f1', textColor: '#ffffff', landingUrl: '', landingUrlAos: '', landingUrlIos: '', landingUrlWeb: '', landingUrlMo: '', textAlign: 'left', openInNewTab: false };
        case 'label':
            return { id, type, area, text: 'ìƒˆ ë¼ë²¨', bgColor: '#F5F5F5', textColor: '#1C1C1C' };
        case 'callout':
            return { id, type, area, title: 'ğŸ’¡ ì°¸ê³ ', content: 'ì¤‘ìš”í•œ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', bgColor: '#F5F5F5', textColor: '#1C1C1C' };
        default:
            return { id, type: 'text', area, content: '<p>ì•Œ ìˆ˜ ì—†ëŠ” ë¸”ë¡ íƒ€ì…</p>' };
    }
};

    // HTML ë‚´ë³´ë‚´ê¸°
    const generateExportedHTML = () => {
        const normalizeRichText = (html) => {
        const tmp = document.createElement('div');
        tmp.innerHTML = html;

        // âœ… ë¹ˆ í…ìŠ¤íŠ¸ íƒœê·¸ë§Œ ì œê±° (spacerì˜ divëŠ” ì•ˆì „)
        tmp.querySelectorAll('p, h1, h2, h3, h4, h5, h6, span').forEach(el => {
            if (!el.textContent.trim() && !el.querySelector('img, br')) {
                el.remove();
            }
        });

        tmp.querySelectorAll('font[color]').forEach(el => {
            const color = el.getAttribute('color');
            const span = document.createElement('span');
            if (color) span.style.color = color;
            span.innerHTML = el.innerHTML;
            el.parentNode.replaceChild(span, el);
        });
        tmp.querySelectorAll('b, strong').forEach(el => { el.style.fontWeight = '700'; });
        tmp.querySelectorAll('i, em').forEach(el => { el.style.fontStyle = 'italic'; });
        tmp.querySelectorAll('u').forEach(el => { el.style.textDecoration = 'underline'; });
        return tmp.innerHTML;
    };
        
        const canvasWidth = widthInput.value;
        const paddingTop = paddingInput.value;
        const hideSearchResults = document.getElementById('hide-search-results').checked;
        
        const wrapperMaxWidth = sidebarBlocks.length > 0 ? '1200px' : `${canvasWidth}px`;

let html = `
<!-- PUBLOG Editor Export -->
<style>
  .plg-wrapper { 
    max-width: ${wrapperMaxWidth}; 
    margin: 0 auto; 
    display: flex; 
    gap: 0; 
    align-items: flex-start; 
    padding: 0; 16px;
    min-height: 100vh;
    justify-content: center;
  }
  .plg-export { 
    font-family: 'Montserrat', 'YoonGothicPro740', 'YoonGothicPro760', 'YoonGothicPro780', sans-serif; 
    color: #1d1d1f; 
    line-height: 1.6; 
    flex: ${sidebarBlocks.length > 0 ? '1' : 'none'}; 
    max-width: ${canvasWidth}px; 
    width: ${sidebarBlocks.length > 0 ? 'auto' : canvasWidth + 'px'};
    padding: ${paddingTop}px 0px 40px; 
    box-sizing: border-box; 
    background: #fff; 
  }
  .plg-export *, .plg-export *::before, .plg-export *::after { box-sizing: border-box; }
  .plg-export a { text-decoration: none; }
  .plg-export img { max-width: 100%; height: auto; display: block; }
  .plg-export h1 { font-size: 28px; margin: 0 0 0.4em; line-height: 1.3; font-weight: 600; }
  .plg-export h2 { font-size: 22px; margin: 0.9em 0 0.4em; line-height: 1.35; font-weight: 600; }
  .plg-export h3 { font-size: 18px; margin: 0.8em 0 0.4em; line-height: 1.4; font-weight: 600; }
  .plg-export p { margin: 0.5em 0; line-height: 2.0; font-size: 16px; }
  .plg-export b, .plg-export strong { font-weight: 700 !important; }
  .plg-export i, .plg-export em { font-style: italic !important; }
  .plg-export u { text-decoration: underline !important; }
  .plg-image-split { display: flex; gap: 16px; margin: 20px 0; }
  .plg-image-split-item { flex: 1; text-align: center; }
  .plg-image-caption { font-size: 14px; color: #666; margin-top: 8px; }
  .plg-columns { display: flex; gap: 16px; margin: 12px 0; }
  .plg-column { flex: 1; }
  .plg-btn-center { text-align: center; padding: 16px 0; }
  .plg-btn { 
    display: inline-block; 
    padding: 14px 28px; 
    border-radius: 9999px; 
    font-weight: 700; 
    text-align: center; 
    width: 25%;
    min-width: 150px; 
    cursor: pointer; 
    transition: opacity 0.2s; 
  }
  .plg-btn:hover { opacity: 0.9; }
  .plg-bnr { 
    padding: 24px 24px;
    border-radius: 12px; 
    margin: 24px 0; 
    cursor: pointer; 
  }
  .plg-bnr-sub { 
    font-size: 14px !important;  /* âœ… 0.95em â†’ 14px */
    opacity: 0.8; 
    margin: 0 0 8px 0 !important;
    line-height: 1.4 !important;
  }
  .plg-bnr-main { 
    font-size: 18px !important;  /* âœ… 1.15em â†’ 18px */
    font-weight: 700; 
    margin: 0 !important;
    line-height: 1.3 !important;
  }
  .plg-label { 
    display: inline-block; 
    padding: 4px 12px; 
    border-radius: 9999px; 
    font-size: 0.875em; 
    font-weight: 500; 
    margin: 10px 0 0 0;
  }
  .plg-callout { 
    padding: 28px;  /* âœ… 20px â†’ 28px */
    border-radius: 12px; 
    margin: 20px 0; 
  }
  .plg-callout-title { 
      font-weight: 600; 
      margin-bottom: 8px;  /* âœ… 4px â†’ 8px */
      font-size: 16px;  /* âœ… ì¶”ê°€ */
  }
  .plg-callout-content { 
      opacity: 0.9; 
      font-size: 16px;  /* âœ… ì¶”ê°€ */
      line-height: 1.8;  /* âœ… 1.5 â†’ 1.8 */
      white-space: pre-wrap;
  }
   .plg-toggle {
    margin: 8px 0;
  }
  .plg-toggle-header {
    padding: 6px 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    user-select: none;
    transition: opacity 0.2s;
  }
  .plg-toggle-header:hover {
    opacity: 0.7;
  }
  .plg-toggle-icon {
    width: 14px;
    height: 14px;
    flex-shrink: 0;
    transition: transform 0.2s ease;
    color: #6b7280;
  }
  .plg-toggle-icon.open {
    transform: rotate(90deg);
  }
  .plg-toggle-icon.closed {
    transform: rotate(0deg);
  }
  .plg-toggle-title {
    flex: 1;
    font-size: 14px;
    font-weight: 400;
    line-height: 1.6;
  }
  .plg-toggle-content {
    padding-left: 20px;
    margin-top: 2px;
    overflow: hidden;
    transition: all 0.2s ease;
    font-size: 14px;
  }
  .plg-toggle-content.closed {
    max-height: 0;
    margin-top: 0;
    opacity: 0;
  }
  .plg-toggle-content p {
    margin: 0;
    line-height: 1.6;
  }
  .plg-toggle-content p + p {
    margin-top: 8px;
  }
  .plg-divider-vertical { 
    width: 80px; 
    flex-shrink: 0; 
    display: flex; 
    justify-content: center; 
    padding-top: ${paddingTop}px; 
    align-self: stretch; 
  }
  .plg-divider-vertical > div { width: 1px; background: #e5e7eb; height: 100%; }
  .plg-divider-horizontal { display: none; }
  .plg-sidebar { 
    width: 200px;  
    padding: ${paddingTop}px 0px 40px; 
    box-sizing: border-box; 
    position: sticky; 
    top: 0; 
    align-self: flex-start; 
    max-height: 100vh; 
    overflow-y: auto; 
  }
  .plg-list-item { 
    background: #fff; 
    padding: 14px 12px; 
    border-radius: 8px; 
    margin-bottom: 8px; 
    transition: all 0.2s; 
    display: block; 
    text-decoration: none; 
  }
  .plg-list-item.has-border { border: 1px solid #e5e7eb; }
  .plg-list-item.no-border { padding: 13px 0; background: transparent; }
  .plg-list-item:hover .plg-list-title { color: #6366f1; }
  .plg-list-title { 
    font-size: 0.9rem; 
    font-weight: 600; 
    color: #374151; 
    margin-bottom: 4px; 
    line-height: 1.3; 
    transition: color 0.2s; 
  }
  .plg-list-subtitle { 
    font-size: 0.8rem; 
    color: #9ca3af; 
    line-height: 1.4; 
  }
  
  @media (max-width: 1024px) {
  .plg-wrapper { flex-direction: column; max-width: 100%; padding: 0; }
  .plg-divider-vertical { display: none; }
  .plg-divider-horizontal { 
    display: flex; 
    width: 100%; 
    padding: 32px 0; 
    align-items: center; 
    justify-content: center; 
  }
  .plg-divider-horizontal > div { 
    width: 100%; 
    height: 1px; 
    background: #e5e7eb; 
  }
  .plg-sidebar { 
    position: static; 
    width: 100%; 
    padding: 0 24px 40px; 
  }
  .plg-export {
    max-width: 100%;
    width: 100%;
    padding: ${paddingTop}px 24px 40px;
  }
  .plg-image-split, .plg-columns {
    flex-direction: column;
    gap: 12px;
  }
}
</style>
<div class="plg-wrapper">
  <section class="plg-export">`;
        
        blocks.forEach(block => {
            switch(block.type) {
                case 'text':
                    html += `\n    <div style="margin-bottom: 12px;">${normalizeRichText(block.content)}</div>`;
                    break;
                case 'columns':
                    const columnCount = block.columnCount || 2;
                    const columns = block.columns || [];

                    let columnsHTML = '';
                    for (let i = 0; i < columnCount; i++) {
                        const columnBlocks = columns[i] || [];
                        let columnBlocksHTML = '';

                        // ê° ì—´ì˜ ë¸”ë¡ë“¤ì„ ë Œë”ë§
                        columnBlocks.forEach(colBlock => {
                            switch(colBlock.type) {
                                case 'text':
                                    columnBlocksHTML += `\n        <div style="margin-bottom: 12px;">${normalizeRichText(colBlock.content)}</div>`;
                                    break;
                                case 'image':
                                    // ì´ë¯¸ì§€ ë¸”ë¡ ë Œë”ë§ (ë‹¨ìˆœí™” ë²„ì „ - ë‹¨ì¼ ì´ë¯¸ì§€ë§Œ)
                                    const img = colBlock.images?.[0] || {};
                                    const altText = img.caption ? (img.caption.replace(/<[^>]*>/g, '').trim() || '') : '';
                                    columnBlocksHTML += `\n        <div style="margin: 12px 0; text-align: center;">
            <img src="${img.url || colBlock.url || ''}" alt="${altText}" style="width: 100%; border-radius: 0;" />
            ${img.caption || colBlock.caption ? `<div style="font-size: 14px; color: #666; margin-top: 8px;">${normalizeRichText(img.caption || colBlock.caption || '')}</div>` : ''}
        </div>`;
                                    break;
                                case 'divider':
                                    columnBlocksHTML += `\n        <div style="border-top: 1px solid #e5e7eb; margin: 12px 0;"></div>`;
                                    break;
                                case 'spacer':
                                    columnBlocksHTML += `\n        <div style="height: ${colBlock.height || 20}px;"></div>`;
                                    break;
                                case 'button':
                                    const btnStyle = `background-color: ${colBlock.bgColor}; color: ${colBlock.textColor};`;
                                    columnBlocksHTML += `\n        <div style="text-align: center; padding: 12px 0;"><span class="plg-btn" style="${btnStyle}; display: inline-block; padding: 12px 24px; border-radius: 9999px; font-weight: 700;">${colBlock.text}</span></div>`;
                                    break;
                                default:
                                    // ê¸°íƒ€ ë¸”ë¡ íƒ€ì…
                                    break;
                            }
                        });

                        columnsHTML += `\n      <div class="plg-column" style="flex: 1;">${columnBlocksHTML || '<div style="min-height: 20px;"></div>'}</div>`;
                    }

                    html += `\n    <div class="plg-columns">${columnsHTML}
    </div>`;
                    break;
                case 'toggle':
            const toggleId = `toggle-${block.id.substring(0, 8)}`;
            const openClass = block.isOpen ? 'open' : 'closed';
            const contentDisplay = block.isOpen ? '' : ' closed';
            
            html += `\n    <div class="plg-toggle">
      <div class="plg-toggle-header" onclick="toggleContent('${toggleId}')">
        <svg class="plg-toggle-icon ${openClass}" id="${toggleId}-icon" fill="currentColor" viewBox="0 0 16 16">
          <path d="M6 4l6 4-6 4V4z"/>
        </svg>
        <div class="plg-toggle-title">${normalizeRichText(block.title)}</div>
      </div>
      <div class="plg-toggle-content${contentDisplay}" id="${toggleId}-content">
        ${normalizeRichText(block.content)}
      </div>
    </div>`;
            break;
                case 'image':
            // í•˜ìœ„ í˜¸í™˜ì„± ì²˜ë¦¬
            if (block.isSplit && !block.imageCount) block.imageCount = 2;
            if (block.leftImage && !block.images) {
                block.images = [block.leftImage, block.rightImage || {}];
                block.imageCount = 2;
            }
            if (block.url && !block.images) {
                block.images = [{
                    url: block.url,
                    caption: block.caption || '',
                    landingUrl: block.landingUrl || '',
                    landingUrlAos: block.landingUrlAos || '',
                    landingUrlIos: block.landingUrlIos || '',
                    landingUrlWeb: block.landingUrlWeb || '',
                    landingUrlMo: block.landingUrlMo || '',
                    openInNewTab: block.openInNewTab || false
                }];
                block.imageCount = 1;
            }

            const count = block.imageCount || 1;
            const images = block.images || [];

            if (count === 1) {
                // ë‹¨ì¼ ì´ë¯¸ì§€
                const img = images[0] || {};
                const imgTarget = (img.openInNewTab ?? false) ? ' target="_blank"' : '';
                const hasImgUrl = img.landingUrlAos || img.landingUrlIos || img.landingUrlWeb || img.landingUrlMo || img.landingUrl;
                const altText = img.caption ? (img.caption.replace(/<[^>]*>/g, '').trim() || '') : '';
                const imgWrapper = hasImgUrl ?
                    `<a href="#" class="plg-device-link"${imgTarget} data-url-aos="${img.landingUrlAos || ''}" data-url-ios="${img.landingUrlIos || ''}" data-url-web="${img.landingUrlWeb || ''}" data-url-mo="${img.landingUrlMo || ''}" data-url-default="${img.landingUrl || ''}" style="display: block;">
                        <img src="${img.url}" alt="${altText}" style="border-radius: 0; box-shadow: none;" />
                    </a>` :
                    `<img src="${img.url}" alt="${altText}" style="border-radius: 0; box-shadow: none;" />`;
                html += `\n    <div style="margin: 20px 0; text-align: center;">
                    ${imgWrapper}
                    ${img.caption ? `<div class="plg-image-caption">${normalizeRichText(img.caption)}</div>` : ''}
                </div>`;
            } else {
                // 2~4ë¶„í•  ì´ë¯¸ì§€
                let imagesHTML = '';
                for (let i = 0; i < count; i++) {
                    const img = images[i] || {};
                    const imgTarget = (img.openInNewTab ?? false) ? ' target="_blank"' : '';
                    const hasImgUrl = img.landingUrlAos || img.landingUrlIos || img.landingUrlWeb || img.landingUrlMo || img.landingUrl;
                    const altText = img.caption ? (img.caption.replace(/<[^>]*>/g, '').trim() || '') : '';

                    const imgHTML = hasImgUrl ?
                        `<a href="#" class="plg-device-link"${imgTarget} data-url-aos="${img.landingUrlAos || ''}" data-url-ios="${img.landingUrlIos || ''}" data-url-web="${img.landingUrlWeb || ''}" data-url-mo="${img.landingUrlMo || ''}" data-url-default="${img.landingUrl || ''}" style="display: block;">
                            <img src="${img.url || ''}" alt="${altText}" style="width: 100%; border-radius: 0; box-shadow: none;" />
                        </a>` :
                        `<img src="${img.url || ''}" alt="${altText}" style="width: 100%; border-radius: 0; box-shadow: none;" />`;

                    imagesHTML += `
              <div class="plg-image-split-item">
                ${imgHTML}
                ${img.caption ? `<div class="plg-image-caption">${normalizeRichText(img.caption)}</div>` : ''}
              </div>`;
                }

                html += `\n    <div class="plg-image-split">${imagesHTML}
            </div>`;
            }
            break;
                case 'divider':
                    html += `\n    <div style="border-top: 1px solid #e5e7eb; margin: 20px 0;"></div>`;
                    break;
                case 'spacer':
                    html += `\n    <div style="height: ${block.height}px;"></div>`;
                    break;
                case 'button':
    const btnStyle = `background-color: ${block.bgColor}; color: ${block.textColor};`;
    const btnTarget = (block.openInNewTab ?? false) ? ' target="_blank"' : '';
    const hasBtnUrl = block.landingUrlAos || block.landingUrlIos || block.landingUrlWeb || block.landingUrlMo || block.landingUrl;
    const btnElement = hasBtnUrl ?
        `<a href="#" class="plg-btn plg-device-link"${btnTarget} data-url-aos="${block.landingUrlAos || ''}" data-url-ios="${block.landingUrlIos || ''}" data-url-web="${block.landingUrlWeb || ''}" data-url-mo="${block.landingUrlMo || ''}" data-url-default="${block.landingUrl || ''}" style="${btnStyle}">${block.text}</a>` :
        `<span class="plg-btn" style="${btnStyle}">${block.text}</span>`;
    html += `\n    <div class="plg-btn-center">${btnElement}</div>`;
    break;
                 case 'banner':
    const bAlign = block.textAlign || 'left';
    const bStyle = `background-color: ${block.bgColor}; color: ${block.textColor}; text-align: ${bAlign};`;
    const bInner = `\n      <p class="plg-bnr-sub">${block.subText}</p>\n      <p class="plg-bnr-main">${block.mainText}</p>`;
    const hasBnrUrl = block.landingUrlAos || block.landingUrlIos || block.landingUrlWeb || block.landingUrlMo || block.landingUrl;
    if (hasBnrUrl) {
        const bTarget = (block.openInNewTab ?? false) ? ' target="_blank"' : '';
        html += `\n    <a href="#" class="plg-device-link"${bTarget} data-url-aos="${block.landingUrlAos || ''}" data-url-ios="${block.landingUrlIos || ''}" data-url-web="${block.landingUrlWeb || ''}" data-url-mo="${block.landingUrlMo || ''}" data-url-default="${block.landingUrl || ''}" style="display: block; text-decoration: none;"><div class="plg-bnr" style="${bStyle}">${bInner}\n    </div></a>`;
    } else {
        html += `\n    <div class="plg-bnr" style="${bStyle}">${bInner}\n    </div>`;
    }
    break;
                case 'label':
                    case 'label':
                    const lblStyle = `background-color: ${block.bgColor}; color: ${block.textColor};`;
                    html += `\n    <div style="margin: 0 0 12px 0;"><span class="plg-label" style="${lblStyle}">${block.text}</span></div>`;
                    break;
                case 'callout':
            const coStyle = `background-color: ${block.bgColor}; color: ${block.textColor};`;
            html += `\n    <div class="plg-callout" style="${coStyle}">
              <div class="plg-callout-title">${block.title}</div>
              <div class="plg-callout-content">${block.content}</div>
            </div>`;
            break;
            }
        });
        
        html += `\n  </section>`;
        
        if (sidebarBlocks.length > 0) {
            html += `\n  <div class="plg-divider plg-divider-vertical"><div></div></div>`;
            html += `\n  <aside class="plg-sidebar">`;
            html += `\n    <div class="plg-divider plg-divider-horizontal"><div></div></div>`;
            
            sidebarBlocks.forEach(block => {
                if (block.type === 'text') {
                    html += `\n    <div style="margin: 8px 0 16px; font-size: 0.9375rem; line-height: 1.6;">${normalizeRichText(block.content)}</div>`;
                } else if (block.type === 'image') {
                    // í•˜ìœ„ í˜¸í™˜ì„± ì²˜ë¦¬
                    if (block.isSplit && !block.imageCount) block.imageCount = 2;
                    if (block.leftImage && !block.images) {
                        block.images = [block.leftImage, block.rightImage || {}];
                        block.imageCount = 2;
                    }
                    if (block.url && !block.images) {
                        block.images = [{
                            url: block.url,
                            caption: block.caption || '',
                            landingUrl: block.landingUrl || '',
                            landingUrlAos: block.landingUrlAos || '',
                            landingUrlIos: block.landingUrlIos || '',
                            landingUrlWeb: block.landingUrlWeb || '',
                            landingUrlMo: block.landingUrlMo || '',
                            openInNewTab: block.openInNewTab || false
                        }];
                        block.imageCount = 1;
                    }

                    const count = block.imageCount || 1;
                    const images = block.images || [];

                    if (count === 1) {
                        // ë‹¨ì¼ ì´ë¯¸ì§€
                        const img = images[0] || {};
                        const imgTarget = (img.openInNewTab ?? false) ? ' target="_blank"' : '';
                        const hasSbImgUrl = img.landingUrlAos || img.landingUrlIos || img.landingUrlWeb || img.landingUrlMo || img.landingUrl;
                        const altText = img.caption ? (img.caption.replace(/<[^>]*>/g, '').trim() || '') : '';
                        const sImgWrapper = hasSbImgUrl ?
                            `<a href="#" class="plg-device-link"${imgTarget} data-url-aos="${img.landingUrlAos || ''}" data-url-ios="${img.landingUrlIos || ''}" data-url-web="${img.landingUrlWeb || ''}" data-url-mo="${img.landingUrlMo || ''}" data-url-default="${img.landingUrl || ''}"><img src="${img.url}" alt="${altText}" style="width: 100%; border-radius: 8px;" /></a>` :
                            `<img src="${img.url}" alt="${altText}" style="width: 100%; border-radius: 8px;" />`;
                        html += `\n    <div style="margin: 12px 0;">${sImgWrapper}${img.caption ? `<div style="font-size: 0.75rem; color: #666; margin-top: 4px;">${normalizeRichText(img.caption)}</div>` : ''}</div>`;
                    } else {
                        // 2~4ë¶„í•  ì´ë¯¸ì§€
                        let imagesHTML = '';
                        for (let i = 0; i < count; i++) {
                            const img = images[i] || {};
                            const imgTarget = (img.openInNewTab ?? false) ? ' target="_blank"' : '';
                            const hasSbImgUrl = img.landingUrlAos || img.landingUrlIos || img.landingUrlWeb || img.landingUrlMo || img.landingUrl;
                            const altText = img.caption ? (img.caption.replace(/<[^>]*>/g, '').trim() || '') : '';

                            const imgHTML = hasSbImgUrl ?
                                `<a href="#" class="plg-device-link"${imgTarget} data-url-aos="${img.landingUrlAos || ''}" data-url-ios="${img.landingUrlIos || ''}" data-url-web="${img.landingUrlWeb || ''}" data-url-mo="${img.landingUrlMo || ''}" data-url-default="${img.landingUrl || ''}"><img src="${img.url || ''}" alt="${altText}" style="width: 100%; border-radius: 8px;" /></a>` :
                                `<img src="${img.url || ''}" alt="${altText}" style="width: 100%; border-radius: 8px;" />`;

                            imagesHTML += `\n          <div class="plg-image-split-item">${imgHTML}${img.caption ? `<div style="font-size: 0.75rem; color: #666; margin-top: 4px; text-align: center;">${normalizeRichText(img.caption)}</div>` : ''}</div>`;
                        }

                        html += `\n    <div class="plg-image-split" style="margin: 12px 0;">${imagesHTML}
        </div>`;
                    }
                } else if (block.type === 'divider') {
                    html += `\n    <div style="border-top: 1px solid #e5e7eb; margin: 12px 0;"></div>`;
                } else if (block.type === 'spacer') {
                    html += `\n    <div style="height: ${block.height}px;"></div>`;
                } else if (block.type === 'listitem') {
    const borderClass = block.showBorder ? ' has-border' : ' no-border';
    const hasListUrl = block.landingUrlAos || block.landingUrlIos || block.landingUrlWeb || block.landingUrlMo || block.landingUrl;
    if (hasListUrl) {
        const listTarget = (block.openInNewTab ?? false) ? ' target="_blank"' : '';
        html += `\n    <a href="#" class="plg-list-item plg-device-link${borderClass}"${listTarget} data-url-aos="${block.landingUrlAos || ''}" data-url-ios="${block.landingUrlIos || ''}" data-url-web="${block.landingUrlWeb || ''}" data-url-mo="${block.landingUrlMo || ''}" data-url-default="${block.landingUrl || ''}">
  <div class="plg-list-title">${block.title}</div>
  <div class="plg-list-subtitle">${block.subtitle}</div>
</a>`;
    } else {
        html += `\n    <div class="plg-list-item${borderClass}">
  <div class="plg-list-title">${block.title}</div>
  <div class="plg-list-subtitle">${block.subtitle}</div>
</div>`;
    }
}
            });
            
            html += `\n  </aside>`;
        }
        
        html += `\n</div>`;
       
      // í† ê¸€ ê¸°ëŠ¥ JavaScript + ë””ë°”ì´ìŠ¤ë³„ URL ì„¤ì •
html += `
<script>
function toggleContent(id) {
  var content = document.getElementById(id + '-content');
  var icon = document.getElementById(id + '-icon');

  if (content.classList.contains('closed')) {
    content.classList.remove('closed');
    icon.classList.remove('closed');
    icon.classList.add('open');
  } else {
    content.classList.add('closed');
    icon.classList.remove('open');
    icon.classList.add('closed');
  }
}

// ë””ë°”ì´ìŠ¤ ê°ì§€ ë° URL ì„¤ì •
(function() {
  var hostname = window.location.hostname;
  var device = 'web'; // ê¸°ë³¸ê°’

  if (hostname.indexOf('app100.publog.co.kr') !== -1) {
    device = 'aos';
  } else if (hostname.indexOf('app200.publog.co.kr') !== -1) {
    device = 'ios';
  } else if (hostname.indexOf('m.publog.co.kr') !== -1) {
    device = 'mo';
  } else if (hostname.indexOf('www.publog.co.kr') !== -1) {
    device = 'web';
  }

  // ëª¨ë“  ë””ë°”ì´ìŠ¤ ë§í¬ì— ì ì ˆí•œ URL ì„¤ì •
  var links = document.querySelectorAll('.plg-device-link');
  for (var i = 0; i < links.length; i++) {
    var link = links[i];
    var url = link.getAttribute('data-url-' + device) || link.getAttribute('data-url-default') || '';

    if (url) {
      link.href = url;
    } else {
      // URLì´ ì—†ìœ¼ë©´ í´ë¦­ ë°©ì§€
      link.href = 'javascript:void(0)';
      link.style.cursor = 'default';
    }
  }
})();
<\/script>`;
      
        // ìƒí’ˆ ì˜ì—­ ìˆ¨ê¸°ê¸° ìŠ¤í¬ë¦½íŠ¸
        if (hideSearchResults) {
            html += `
<script>
(function() {
  function enableSticky() {
    var sidebar = document.querySelector('.plg-sidebar');
    if (sidebar) {
      var parent = sidebar.parentElement;
      while (parent && parent !== document.body) {
        var computed = window.getComputedStyle(parent);
        if (computed.overflow !== 'visible' || computed.overflowY !== 'visible') {
          parent.style.overflow = 'visible';
          parent.style.overflowY = 'visible';
        }
        parent = parent.parentElement;
      }
    }
  }

  function hideSearchResults() {
    var searchResult = document.getElementById('search-result');
    if (searchResult) {
      searchResult.style.display = 'none';
    }
    var searchArea = document.querySelector('.search_area');
    if (searchArea) {
      searchArea.style.display = 'none';
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      enableSticky();
      hideSearchResults();
    });
  } else {
    enableSticky();
    hideSearchResults();
  }
})();
<\/script>`;
        }
        
        html += `\n<!-- /PUBLOG Editor Export -->`;
        return html;
    };

    // HTML ë³µì‚¬
    function copyHTML() {
        const htmlCode = generateExportedHTML();
        const textarea = document.createElement('textarea');
        textarea.value = htmlCode;
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
            const success = document.execCommand('copy');
            showToast(success ? 'HTML ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ë³µì‚¬ ì‹¤íŒ¨', success ? 'success' : 'error');
        } catch (err) {
            showToast('ë³µì‚¬ ê¸°ëŠ¥ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
        }
        
        document.body.removeChild(textarea);
    }

    // í† ìŠ¤íŠ¸ ì•Œë¦¼
    const showToast = (msg, type = 'success') => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-emerald-500' : 'bg-red-500';
        
        toast.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg mb-3 transform translate-x-full opacity-0 transition-all duration-300 flex items-center gap-2`;
        toast.innerHTML = `
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                ${type === 'success' ? 
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>' :
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'}
            </svg>
            <span>${msg}</span>`;
        
        container.appendChild(toast);
        setTimeout(() => toast.classList.remove('translate-x-full', 'opacity-0'), 50);
        setTimeout(() => {
            toast.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    };

    // ë„ì›€ë§ ëª¨ë‹¬
    function openHelpModal() {
        const modal = document.getElementById('help-modal');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.add('flex');
            modal.querySelector('div').classList.remove('opacity-0', 'scale-95');
        }, 10);
    }

    function closeHelpModal() {
        const modal = document.getElementById('help-modal');
        modal.querySelector('div').classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }, 300);
    }

    // Undo/Redo
    undoBtn.onclick = () => {
        if (historyIndex > 0) {
            historyIndex--;
            const state = JSON.parse(history[historyIndex]);
            blocks = state.blocks;
            sidebarBlocks = state.sidebarBlocks;
            renderCanvas();
            renderSidebar();
            editor.updateHistoryButtons();
            selectedBlock = null;
            updatePropertiesPanel(null);
        }
    };
    
    redoBtn.onclick = () => {
        if (historyIndex < history.length - 1) {
            historyIndex++;
            const state = JSON.parse(history[historyIndex]);
            blocks = state.blocks;
            sidebarBlocks = state.sidebarBlocks;
            renderCanvas();
            renderSidebar();
            editor.updateHistoryButtons();
            selectedBlock = null;
            updatePropertiesPanel(null);
        }
    };

    // í…ìŠ¤íŠ¸ ì„ íƒ ì´ë²¤íŠ¸
    document.addEventListener('selectionchange', editor.positionToolbar);
    document.addEventListener('mouseup', editor.positionToolbar);
    
    // í´ë¦­ ì´ë²¤íŠ¸ (í…ìŠ¤íŠ¸ íˆ´ë°” ë‹«ê¸°)
    document.addEventListener('click', (e) => {
        if (!e.target.closest('#text-toolbar') && !e.target.closest('.text-block')) {
            textToolbar.classList.remove('show');
            editor.currentTextNode = null;
        }
    });

    // ìº”ë²„ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ - ë¹ˆ ì˜ì—­ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
    canvas.addEventListener('click', (e) => {
        if (e.target.closest('.block-container')) {
            const link = e.target.closest('a');
            if (link || e.target.tagName === 'BUTTON') {
                e.preventDefault();
            }
        } else if (e.target === canvas || e.target.closest('#canvas') && !e.target.closest('.block-container')) {
            // ë¹ˆ ì˜ì—­ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
            document.querySelectorAll('.block-container').forEach(el => {
                el.classList.remove('selected');
            });
            selectedBlock = null;
            updatePropertiesPanel(null);
        }
    });

    sidebarCanvas.addEventListener('click', (e) => {
        if (e.target.closest('.block-container')) {
            const link = e.target.closest('a');
            if (link || e.target.tagName === 'BUTTON') {
                e.preventDefault();
            }
        } else if (e.target === sidebarCanvas || e.target.closest('#sidebar-canvas') && !e.target.closest('.block-container')) {
            // ë¹ˆ ì˜ì—­ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
            document.querySelectorAll('.block-container').forEach(el => {
                el.classList.remove('selected');
            });
            selectedBlock = null;
            updatePropertiesPanel(null);
        }
    });

    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
            e.preventDefault();
            undoBtn.click();
        }
        if ((e.ctrlKey || e.metaKey) && (e.shiftKey && e.key === 'z' || e.key === 'y')) {
            e.preventDefault();
            redoBtn.click();
        }
        if ((e.key === 'Delete' || e.key === 'Backspace') && selectedBlock) {
            const activeEl = document.activeElement;
            if (!activeEl.closest('.text-block') && !activeEl.closest('input') && !activeEl.closest('textarea')) {
                e.preventDefault();
                deleteSelectedBlock();
            }
        }
    });

    // ì´ˆê¸°í™”
    const init = () => {
        // LocalStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œë„
        const loaded = loadFromLocalStorage();
        
        // ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ
        if (!loaded) {
            blocks = [
                {
                    id: generateUUID(),
                    type: 'label',
                    area: 'main',
                    text: 'ë¼ë²¨ ë‚´ìš© ì…ë ¥',
                    bgColor: '#F5F5F5',
                    textColor: '#1C1C1C'
                },
                {
                    id: generateUUID(),
                    type: 'text',
                    area: 'main',
                    content: '<h1 style="font-size: 28px;">ë©”ì¸ íƒ€ì´í‹€ ì˜ì—­</h1>'
                },
                {
                    id: generateUUID(),
                    type: 'text',
                    area: 'main',
                    content: '<p style="font-size: 16px; color: #5C5C5C;">ì„œë¸Œ íƒ€ì´í‹€ ì˜ì—­</p>'
                },
                {
                    id: generateUUID(),
                    type: 'divider',
                    area: 'main'
                },
                {
                    id: generateUUID(),
                    type: 'image',
                    area: 'main',
                    url: 'https://placehold.co/600x400/222450/FFFFFF?text=Placeholder+Image',
                    caption: '',
                    landingUrl: '',
                    openInNewTab: false  // âœ… ì¶”ê°€
                },
                {
                    id: generateUUID(),
                    type: 'text',
                    area: 'main',
                    content: '<p>ì™¼ìª½ì—ì„œ ë¸”ë¡ì„ ë“œë˜ê·¸í•˜ì—¬ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”. í…ìŠ¤íŠ¸ ë¸”ë¡ì„ í´ë¦­í•˜ê³  ë“œë˜ê·¸í•˜ì—¬ ì˜ì—­ì„ ì„ íƒí•˜ë©´ ìœ„ì— í¸ì§‘ íˆ´ë°”ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. ë‹¤ë¥¸ ë¸”ë¡ì€ í´ë¦­í•˜ì—¬ ì˜¤ë¥¸ìª½ íŒ¨ë„ì—ì„œ ì†ì„±ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>'
                }
            ];
            
            sidebarBlocks = [
                {
                    id: generateUUID(),
                    type: 'text',
                    area: 'sidebar',
                    content: '<p>ë¦¬ìŠ¤íŠ¸ ì˜ì—­ íƒ€ì´í‹€</p>'
                },
                {
                    id: generateUUID(),
                    type: 'spacer',
                    area: 'sidebar',
                    height: 10
                },
                {
                    id: generateUUID(),
                    type: 'listitem',
                    area: 'sidebar',
                    title: 'ë¦¬ìŠ¤íŠ¸ ì œëª©',
                    subtitle: 'ë¦¬ìŠ¤íŠ¸ ì†Œì œëª©',
                    landingUrl: '',
                    showBorder: false,
                    openInNewTab: false  // âœ… ì¶”ê°€
                },
                {
                    id: generateUUID(),
                    type: 'listitem',
                    area: 'sidebar',
                    title: 'ë¦¬ìŠ¤íŠ¸ ì œëª©',
                    subtitle: 'ë¦¬ìŠ¤íŠ¸ ì†Œì œëª©',
                    landingUrl: '',
                    showBorder: false
                }
            ];
            
            editor.saveState();
            renderCanvas();
            renderSidebar();
        }
        
        editor.updateHistoryButtons();
    };

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.onload = init;
    
    // ê°œë°œì ë„êµ¬ìš© ì „ì—­ í•¨ìˆ˜
    window.editorDebug = {
        getBlocks: () => ({ blocks, sidebarBlocks }),
        setBlocks: (newBlocks) => {
            blocks = newBlocks.blocks || [];
            sidebarBlocks = newBlocks.sidebarBlocks || [];
            renderCanvas();
            renderSidebar();
            editor.saveState();
        },
        exportJSON: () => {
            const data = { blocks, sidebarBlocks };
            console.log(JSON.stringify(data, null, 2));
            return data;
        },
        importJSON: (jsonString) => {
            try {
                const data = JSON.parse(jsonString);
                blocks = data.blocks || [];
                sidebarBlocks = data.sidebarBlocks || [];
                renderCanvas();
                renderSidebar();
                editor.saveState();
                showToast('JSON ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
            } catch (err) {
                showToast('JSON íŒŒì‹± ì˜¤ë¥˜: ' + err.message, 'error');
            }
        },
        clearAll: () => {
            if (confirm('ëª¨ë“  ë¸”ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                blocks = [];
                sidebarBlocks = [];
                renderCanvas();
                renderSidebar();
                editor.saveState();
                selectedBlock = null;
                updatePropertiesPanel(null);
            }
        },
        getHistory: () => ({
            history,
            historyIndex,
            canUndo: historyIndex > 0,
            canRedo: historyIndex < history.length - 1
        })
    };

    // ì½˜ì†”ì— ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥
    console.log('%c PUBLOG Editor v2.0 ', 'background: #6366f1; color: white; font-size: 14px; padding: 4px 8px; border-radius: 4px;');
    console.log('ê°œë°œì ë„êµ¬ ì‚¬ìš© ê°€ëŠ¥:');
    console.log('- editorDebug.getBlocks() : í˜„ì¬ ë¸”ë¡ ë°ì´í„° ì¡°íšŒ');
    console.log('- editorDebug.exportJSON() : JSONìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°');
    console.log('- editorDebug.importJSON(json) : JSONì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°');
    console.log('- editorDebug.clearAll() : ëª¨ë“  ë¸”ë¡ ì‚­ì œ');
    console.log('- editorDebug.getHistory() : íˆìŠ¤í† ë¦¬ ìƒíƒœ ì¡°íšŒ');
    
    </script>
</body>

</html>

